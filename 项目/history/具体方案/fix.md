
首先判断是否是分析类，还是史实搜寻类问题，如果是史实搜寻类，一边将原问题向量检索，一边在网络搜索获取资料，只进行一次，整合后发给LLM，如果是分析类，采用Recat架构，将原问题拆分为多个维度的问题，进行向量检索，和网络搜寻，不断重复上述流程，直到判断资料已经足够，确认后调用llm生成答案

历史穿越，会调用llm为知名历史人物生成人物卡，同时调用检索史料中相关的记载，确保人物性格不会改动

历史穿越流程，当前玩家输入加上上一轮对话进行并行操作，调用llm生成可能用到的角色卡和问题，收到结果后，查询所有可能用到的人物的角色卡，同时进行向量检索可能用到的史料提供历史背景，考虑历史上发生的事


本工作流遵循严耕望先生的治史理念，确立“证据优先，理论为辅”的核心原则。Agent在分析时，必须优先从用户上传的核心史料（一手、二手文献）中寻找答案，外部知识库（如维基百科）主要用于背景补充和事实核查，避免空泛的理论套用。

**工作流全景:**

下面是完整的五个阶段，每个阶段都明确定义了其在史学方法论中的依据、执行的任务、以及输入和输出。

#### **阶段一：主题解构与研究规划 (Deconstruction & Planning)**

- **史学方法论依据:** “选择主题”
    
- **输入:** 用户的原始、可能模糊的查询。
    
- **任务描述:** 这是Agent接到指令后的第一步。它利用其“大脑（Controller）”模块，对用户的查询进行深度理解和分解，将其从一个问题转化为一个可执行的研究项目计划。
    
- **执行步骤:**
    
    1. **意图识别:** 分析用户查询的核心动词（是要求“分析原因”、“比较异同”、“评价影响”还是“叙述过程”？）。
        
    2. **实体抽取:** 调用`Entity_Extractor`工具，识别问题中包含的关键实体（人物、事件、时间、地点、文献名）。
        
    3. **问题分解:** 将复杂问题分解为一系列逻辑上递进的子问题。例如，将“分析安史之乱的经济影响”分解为：1. 安史之乱前的经济状况是怎样？2. 动乱期间对农业、手工业、商业分别造成了哪些破坏？3. 战后出现了哪些新的经济政策或现象？
        
    4. **规划行动序列:** 基于子问题，生成一个初步的行动计划（Action Plan），明确调用哪些工具、查询什么内容。
        
- **输出:** 一个结构化的研究计划（例如JSON格式），包含核心目标、子问题列表和初步的工具调用序列。
    

---

#### **阶段二：证据收集与初步分类 (Collection & Classification)**

- **史学方法论依据:** “收集证据”、“证据分类”
    
- **输入:** 阶段一输出的研究计划。
    
- **任务描述:** Agent根据研究计划，系统性地搜集所有相关的证据，并对其进行初步的来源分类，为后续的考证做准备。
    
- **执行步骤:**
    
    1. **执行计划:** Agent按计划调用其“工具箱”中的工具，如`Advanced_RAG_Search`在指定文献中检索，`External_Database_Query`查询外部数据库。
        
    2. **来源标记:** 为每一条检索到的信息片段（snippet）打上来源标签。
        
    3. **证据分类:** 根据来源，将证据分为：
        
        - **主要证据 (Primary Evidence):** 直接来源于用户上传的核心文献（如《晚明史》的原文），被视为“当代材料”。
            
        - **辅助证据 (Secondary Evidence):** 来源于外部知识库（CBDB、维基百科）或相关研究论文，用于提供背景、定义和交叉验证。
            
- **输出:** 一个带分类标签的原始证据集（Raw Evidence Corpus），每条证据都包含内容、来源（具体到章节/URL）、分类。
    

---

#### **阶段三：双重证据考证 (Dual-Layer Evidence Criticism)**

- **史学方法论依据:** “使用证据”中的“外部考证”与“内部考证”。这是整个工作流最核心、最能体现学术严谨性的环节。
    
- **输入:** 阶段二输出的原始证据集。
    
- **任务描述:** Agent模拟历史学家的考证过程，对每一条证据的“真实性”和“可靠性”进行审查。
    
- **子流程 3a: 外部考证 (External Criticism) - 真实性审查**
    
    - **目标:** 判断证据的真伪，避免使用伪证。
        
    - **执行步骤 (模拟):**
        
        1. **年代与作者鉴定:** 检查证据的元数据（作者、年份），与外部数据库信息比对，寻找是否存在“时代错乱”（Anachronism），如“十四世纪的文献中出现‘美利坚’”这样的错误。
            
        2. **版本与完整性检查:** 检查文献是否有多个版本、是否存在残缺、是否为剽窃或篡改。Agent可以通过检索，查看该文献是否有相关的学术讨论来辅助判断。
            
    - **输出:** 为每条证据附加一个“真实性分数”或标记（例如：高、中、低、存疑）。
        
- **子流程 3b: 内部考证 (Internal Criticism) - 可靠性审查**
    
    - **目标:** 判断证据的可信度，理解作者的真实意图。
        
    - **执行步骤 (利用LLM推理能力):**
        
        1. **作者立场分析:** 提问LLM：“该文献的作者[作者名]，其身份是[官员/文人/僧侣]，写作此文时他/她的处境是[升迁/流放]，其写作动机可能是什么？是否存在潜在偏见？”
            
        2. **内部矛盾检测:** 检查同一文献的不同部分是否存在自相矛盾的陈述。
            
        3. **交叉比对验证:** 将来自不同来源（特别是主要证据和辅助证据之间）的关于同一事件的描述进行比对，找出共同点和矛盾点。
            
        4. **合理性判断:** 评估陈述是否违背常识、人类行为逻辑或已知的历史背景。
            
    - **输出:** 为每条证据附加一个“可靠性分数”或标记，并生成一份简短的“考证摘要”，记录其潜在的偏见或矛盾之处。
        

---

#### **阶段四：分析综合与论点构建 (Synthesis & Argumentation)**

- **史学方法论依据:** “分析方法”（包含分析、假设、综合、排列、推理等技巧）
    
- **输入:** 经过双重考证的、带有分数和摘要的“精炼证据集 (Refined Evidence Set)”。
    
- **任务描述:** 这是从证据到观点的创造性阶段。Agent将零散的证据组织起来，构建一个有逻辑、有说服力的核心论点。
    
- **执行步骤:**
    
    1. **证据筛选与排列:** 根据考证分数，优先选择“真实性”和“可靠性”最高的证据。根据子问题，将相关证据进行分组排列。
        
    2. **建立关联与因果:** 在证据之间寻找关联，尝试构建因果链条（例如，A事件导致了B结果，C政策是对B结果的回应）。
        
    3. **形成核心论点 (Thesis Statement):** 针对用户的原始问题，生成一个或多个核心论点。
        
    4. **构建大纲:** 设计最终答案的逻辑结构（使用你已实现的“有效写作-大纲”技巧），规划引言、主体段落（论点+证据支撑）、结论。
        
- **输出:** 一份详细的回答大纲，其中每个论点都链接了将要引用的、已经过考证的证据。
    

---

#### **阶段五：答案生成与规范呈现 (Generation & Citation)**

- **史学方法论依据:** “传达证据”、“注脚、文献目录”
    
- **输入:** 阶段四输出的回答大纲和精炼证据集。
    
- **任务描述:** 以清晰、规范、学术化的方式，将研究成果呈现给用户。
    
- **执行步骤:**
    
    1. **文本生成:** 根据大纲，用中立、精确的语言（避免情绪化和口语化词汇）撰写最终答案。
        
    2. **动态引注:** 在生成文本时，每当使用一条证据支撑论点，立即在其后生成一个注脚标记（如`[1]`），并记录该注脚对应的详细来源信息。这是学术严谨性的关键体现。
        
    3. **阐释引文:** 如果直接引用原文，Agent必须在引文前后进行阐释，说明引用它的目的和它所证明的观点。
        
    4. **生成文献目录:** 在答案的末尾，自动汇总所有注脚中引用的文献，生成一个格式规范的“参考文献”列表。
        
- **最终输出:** 一份提供给用户的、结构清晰、论证有力、引用规范、完全透明的研究报告式回答。
    

通过实施这一工作流，你的“history agent助手”将不仅仅是信息的检索器，更是一个严谨的、自动化的历史研究流程执行者，极大地提升了其回答的专业度和可信度。
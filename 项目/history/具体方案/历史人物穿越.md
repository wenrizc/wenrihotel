

本方案在原有“基于史实的互动叙事体验”定位基础上，引入“世界书”和“角色卡”两个核心概念，旨在将叙事引擎从一个“剧情的执行者”升级为一个“世界的模拟器”，从而实现更高程度的逻辑自洽性、个性化体验和创作自由度。

#### **一、 核心理念升级**

1. **世界书 (World Book) - 叙事的“物理定律”**:
    
    - 定位：世界书是特定剧本或时代背景下的“规则手册”和“背景设定集”。它定义了叙事环境的边界和内在逻辑，是凌驾于单个人物和事件之上的顶层约束。
        
    - 作用：解决了传统AI叙事中“万事皆有可能”导致的逻辑混乱问题。例如，在“汉末三国”的世界书中，可以定义“不存在超自然法术”、“马镫尚未普及”、“商业活动主要通过‘市’进行”等规则。这为LLM的生成内容提供了坚实的地基，防止出现“秦始皇开坦克”式的脱轨。世界书由官方预设，也支持创作者自定义。
        
2. **角色卡 (Character Card) - 人物的“基因图谱”**:
    
    - 定位：角色卡是将历史人物或自建角色的核心特质进行结构化、数据化的载体。它不仅包含背景故事，更包含可被系统理解和调用的属性、技能、社会关系和初始状态。
        
    - 作用：取代了原方案中较为模糊的“人物知识库”，为叙事引擎和LLM提供了精确的“扮演指南”。系统可以根据角色卡的设定，动态判断角色的行为逻辑、知识边界和能力范围，从而生成高度个性化且符合人物设定的对话与行动。
        

#### **二、 详细技术方案**

**1. 增强的系统架构**

整体架构依然遵循前后端分离，后端以Spring Boot为核心。关键在于对后端服务和数据层的细化：

- **叙事引擎 (Narrative Engine):** 依然是总指挥。但它的决策依据不再仅仅是剧本节点，而是 **剧本节点 + 世界书规则 + 角色卡状态** 的三位一体。
    
- **知识服务层 (Knowledge Service):** 这是一个新增的逻辑服务层，专门负责管理和提供世界书与角色卡的数据。
    
    - **世界书服务:** 根据当前剧本，加载对应的世界书规则。
        
    - **角色卡服务:** 管理所有预设和自建角色的角色卡，并追踪玩家在游戏过程中角色状态的动态变化（如健康值、物品、新习得的信息等）。
        
- **RAG (检索增强生成) 模块:** 定位不变，依然是历史事实的“外部证据”。
    
- **数据层 (Data Layer):** 数据库的设计需要更加具体化。
    

**2. 核心数据模型与数据库设计**

我们将使用PostgreSQL进行主体设计，并结合其`jsonb`类型处理半结构化数据。

- **表: `world_books` (世界书)**
    
    - `id` (PK, SERIAL): 唯一标识
        
    - `name` (VARCHAR): 世界书名称，如“汉末三国”、“晚明风云”
        
    - `description` (TEXT): 设定集描述
        
    - `era` (VARCHAR): 主要覆盖的时代
        
    - `rules` (JSONB): **核心字段**。存储世界规则，例如：
        
        JSON
        
        ```
        {
          "technology_level": "iron_age_late",
          "supernatural_elements": "none",
          "communication_methods": ["horseback_relay", "pigeon"],
          "key_social_structures": ["士农工商", "宗族制"]
        }
        ```
        
    - `creator_id` (FK): 创建者ID，用于UGC内容
        
- **表: `character_cards` (角色卡)**
    
    - `id` (PK, SERIAL): 唯一标识
        
    - `name` (VARCHAR): 角色姓名
        
    - `is_historical` (BOOLEAN): 是否为真实历史人物
        
    - `bio` (TEXT): 生平简介/背景故事
        
    - `attributes` (JSONB): **核心字段**。角色的基础属性，例如：
        
        JSON
        
        ```
        {
          "intelligence": 8, "strength": 5, "charisma": 9, "reputation": 7
        }
        ```
        
    - `skills` (JSONB): 角色掌握的技能，例如：`["辩才", "兵法", "医术"]`
        
    - `relationships` (JSONB): 初始人际关系，例如：`{"曹操": "盟友", "袁绍": "对手"}`
        
    - `initial_state` (JSONB): 登场时的初始状态，例如：
        
        JSON
        
        ```
        {
          "health": "healthy",
          "location": "陈留",
          "mood": "忧虑",
          "knowledge": ["已知晓董卓乱政"]
        }
        ```
        
    - `creator_id` (FK): 创建者ID
        
- **表: `scripts` (剧本)**
    
    - `id` (PK, SERIAL): 剧本ID
        
    - `title` (VARCHAR): 剧本标题
        
    - `world_book_id` (FK): **关联的世界书**，用于加载规则
        
    - `start_node_id` (FK): 起始剧本节点ID
        
    - `creator_id` (FK)
        
- **表: `script_nodes` (剧本节点)**
    
    - `id` (PK, SERIAL): 节点ID
        
    - `script_id` (FK): 所属剧本
        
    - `description_prompt` (TEXT): 场景描述的核心提示（给LLM用）
        
    - `options` (JSONB): 预设的选项和其逻辑，例如：
        
        JSON
        
        ```
        [
          {
            "text": "A. 慷慨陈词，说服众人。",
            "action": "persuasion_check",
            "required_attribute": {"charisma": 7},
            "next_node_success": 101,
            "next_node_fail": 102
          },
          { "text": "D. [自定义输入]", "action": "custom_input" }
        ]
        ```
        
- **Redis (缓存/会话存储):**
    
    - `user_session:{userId}:{scriptId}` (HASH): 存储玩家当前的游戏会话，**不落库**。
        
        - `current_node_id`: 当前所在的剧本节点。
            
        - `character_state`: 动态变化的角色状态，是`character_cards.initial_state`的实时副本，例如健康、物品、心情、新认识的人等。
            

**3. 关键功能实现思路**

- **a. 剧本创作流程 (UGC)**
    
    1. **选择世界观:** 创作者首先选择一个官方或社区创建的“世界书”，这将决定他剧本的基本盘。
        
    2. **设定核心要素:** 输入剧本名称、简介、目标等。
        
    3. **创建/选择角色:** 创作者可以为剧本绑定多个预设的“角色卡”，或使用角色卡创建器自建新角色。
        
    4. **搭建叙事网络:** 使用可视化的节点编辑器，创建`script_nodes`。对于每个节点，创作者只需定义：
        
        - 场景的核心指令（`description_prompt`），如“主角在官渡之战前夜，于曹操大帐内议事”。
            
        - 提供给玩家的选项 (`options`)，并可以关联“角色卡”中的属性或技能进行“检定 (Check)”。例如，设置一个选项需要“辩才”技能或“智力”大于8才能获得最佳效果。
            
    5. **发布剧本:** 系统将创作者定义的内容存入`scripts`和`script_nodes`等数据库表中。
        
- **b. 动态叙事生成流程 (玩家体验)**
    
    1. **初始化:** 玩家选择剧本和角色。叙事引擎从数据库加载`script`、`world_book`、`character_card`信息，并在Redis中创建用户会话，写入角色的初始状态。
        
    2. **构建情境上下文 (Context):** 叙事引擎进入当前`script_node`，准备生成场景。它会从各个服务收集信息：
        
        - **世界书服务:** 获取规则，如“当前时代，‘纸’是稀有品”。
            
        - **角色卡服务:** 获取主角的静态信息（姓名、性格、技能）和动态状态（当前心情“焦虑”、物品“一把剑”）。
            
        - **RAG模块:** 根据当前事件（如“官渡之战”）和人物，从史料库检索关键事实片段。
            
        - **剧本节点:** 获取当前场景的核心指令（“在曹操大帐”）。
            
    3. **Prompt 聚合与生成:** 叙事引擎将上述所有信息整合成一个结构化的、极其丰富的Prompt，发送给LLM。
        
        - **示例Prompt:**
            
            ```
            --- [世界规则] ---
            时代背景：东汉末年。科技：铁器时代。超自然力量：无。核心社会结构：士族门阀。
            
            --- [扮演指令] ---
            你将扮演“荀彧”。你的角色卡如下：{姓名: 荀彧, 属性: {智力:10, 魅力:8}, 技能: ["战略规划", "举荐人才"], 关系: {曹操: "主公"}, 当前状态: {心情:"忧虑", 位置:"曹操大帐"}, 核心记忆: "刚刚力排众议，劝说曹操坚守官渡"}。
            
            --- [史实参考] ---
            根据《三国志》记载，当时曹军军粮将尽，士卒疲惫。曹操曾写信给许都的荀彧，意图退兵。荀彧回信，分析了战略态势，坚定了他继续作战的决心。
            
            --- [场景任务] ---
            现在是官渡之战的关键时刻，你（荀彧）正在大帐内面见曹操。帐外北风呼啸，军心不稳。曹操刚刚表达了缺粮退兵的想法。请以荀彧的第一人称视角，生成一段场景描述，并向曹操说出你的第一句话，以体现你的战略远见和安抚人心的能力。
            ```
            
    4. **呈现与互动:** LLM返回生成的文本。叙事引擎将其展示给玩家，并附上当前节点定义的选项。
        
    5. **决策与检定:** 玩家做出选择。如果该选项需要检定（如`persuasion_check`），叙事引擎会根据Redis中角色的当前属性值（`charisma: 8`）和选项要求（`required: 7`）进行判断，然后跳转到成功或失败对应的下一个`script_node`。
        
    6. **状态更新:** 玩家的选择和事件的结果（如获得新情报、物品，或心情改变）会被更新到Redis的会话状态中。
        
    7. **循环:** 系统进入新的`script_node`，重复步骤2-7。
        

#### **四、 核心创新点总结 (基于新方案)**

1. **双重约束下的高质量生成:** 通过 **“世界书”的宏观逻辑约束** 和 **“RAG”的微观事实约束**，形成了一个双重锚点系统。这使得LLM的生成既符合历史的“神”（内在逻辑），也符合历史的“形”（具体事件），极大提升了内容的质量与沉浸感。
    
2. **结构化数据驱动的深度扮演:** “角色卡”将人物从一段模糊的文本描述，变成了可被程序理解和运算的结构化数据。这使得系统可以实现更复杂的“技能检定”、“属性判定”、“状态影响”等游戏化机制，让玩家的每一次选择都与其角色的能力息息相关。
    
3. **创作即“配置”的UGC生态:** 创作者的工作从“写小说”变成了“设计世界规则、定义人物卡、配置剧情节点”。他们提供故事的“蓝图”和“骨架”，由AI负责生成具体的“血肉”。这种模式大幅降低了创作门槛，同时保证了产出内容的丰富性和一致性，为平台的可持续发展提供了强大动力。
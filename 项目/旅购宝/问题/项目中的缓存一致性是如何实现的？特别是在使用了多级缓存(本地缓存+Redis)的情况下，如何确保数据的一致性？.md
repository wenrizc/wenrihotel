
## 一、多级缓存架构概述

项目采用了三级数据访问架构：
- 第一级：本地缓存（Caffeine）
- 第二级：分布式缓存（Redis）
- 第三级：数据库（MySQL）

这种设计在提高访问速度的同时，也增加了数据一致性维护的复杂度。

## 二、Cache Aside 模式的应用与优化

### 1. 基本更新策略

项目基于经典的Cache Aside（旁路缓存）模式，并进行了适应性优化：

- **写操作流程**：
  1. 先更新数据库
  2. 再删除相关缓存（而非更新缓存）
  3. 采用延迟双删策略处理边缘情况

- **读操作流程**：
  1. 先查本地缓存
  2. 本地未命中则查Redis
  3. Redis未命中则查数据库并回填缓存

### 2. 延迟双删策略

为解决并发场景下的缓存不一致问题，项目实现了延迟双删机制：

1. 更新数据库前先删除相关缓存
2. 更新数据库
3. 短暂休眠（通常为10ms）
4. 再次删除相关缓存

这种策略有效解决了"读写并发"导致的数据不一致问题，尤其是在高并发场景下。

## 三、统一缓存管理与更新机制

### 1. 缓存抽象层

项目设计了统一的缓存抽象层`CacheService`接口和实现，集中管理缓存操作：

- 提供统一的读写API，屏蔽底层缓存实现细节
- 封装多级缓存查询、更新、删除逻辑
- 支持批量操作和前缀删除功能

### 2. 多级缓存联动更新

当数据发生变更时，触发多级缓存联动更新机制：

- 数据库更新后，立即清除Redis和本地缓存
- 采用"删除优先于添加"的策略，确保更新的原子性
- 针对集合类数据，实现精确更新和部分失效策略

## 四、分布式环境下的缓存一致性

### 1. 消息通知机制

项目使用发布订阅功能实现多实例间的缓存同步：

1. 当实例A更新数据并清除本地缓存时，发布缓存失效消息
2. 其他实例接收到消息后，清除各自的本地缓存
3. 通过Redis的`PUBLISH/SUBSCRIBE`命令实现消息传递
4. 使用专用通道(如`cache:invalidate`)传输失效消息

### 2. 缓存失效消息结构设计

缓存失效消息包含以下关键信息：

- 缓存键或键模式（支持精确匹配和前缀模式）
- 操作类型（单键删除、批量删除、模式删除等）
- 来源实例标识（避免消息循环处理）
- 时间戳（处理消息过期和乱序问题）

### 3. 异步监听与处理

每个应用实例启动专门的缓存消息监听器：

- 使用独立线程池处理缓存失效消息
- 实现幂等性处理，避免重复失效操作
- 优先级队列处理消息，确保关键数据优先处理

## 五、版本控制与冲突解决

### 1. 数据版本管理

针对高价值数据，项目实现了版本控制机制：

- 在Redis中存储数据时附带版本号
- 本地缓存同步存储数据版本信息
- 读取时比对版本号，发现不一致时自动刷新

### 2. 乐观锁与CAS更新

对于并发更新频繁的数据（如库存、点赞数），采用乐观锁策略：

- 数据库层面使用版本号或时间戳实现乐观锁
- Redis层面使用CAS更新（通过Lua脚本保证原子性）
- 更新失败时自动重试或走降级策略

## 六、特殊场景缓存一致性解决方案

### 1. 热点数据处理

针对高频访问的热点数据（如秒杀商品）：

- 使用"逻辑过期"策略而非物理过期
- 维护更新锁与更新标志，控制并发更新
- 异步更新机制，避免缓存击穿

### 2. 大批量数据更新

当需要更新大量相关数据时：

- 采用缓存预热策略，先构建新缓存再切换
- 分批次异步更新，避免缓存雪崩
- 利用Canal监听数据库变更实现被动更新

### 3. 不同业务场景的差异化策略

项目根据业务场景对缓存策略进行差异化设计：

- **用户数据**：采用主动更新策略，变更立即生效
- **商铺信息**：短期不一致可接受，采用异步更新机制
- **交易数据**：强一致性要求，实现同步更新或不缓存
- **静态数据**：长时间缓存，结合版本标记判断更新

## 七、缓存监控与自修复机制

### 1. 缓存健康监控

- 维护缓存命中率、一致性指标的实时监控
- 当发现缓存异常模式时发出告警
- 记录更新操作日志，支持问题回溯

### 2. 自动修复机制

系统实现了缓存自动修复功能：

- 定期抽样检查本地缓存与Redis缓存的一致性
- 发现不一致时自动修复并记录日志
- 临界情况下支持全量缓存重建

### 3. 兜底策略

为应对极端情况，系统设计了兜底机制：

- 缓存操作异常时自动回退到数据库查询
- 缓存更新失败时记录重试队列，定期重试
- 定时任务检查并修复长期不一致的数据

## 总结

项目采用了**消息通知 + 差异化过期时间 + 重试机制 + 定时维护**的混合策略来处理多级缓存一致性问题，通过系统化的设计实现了多级缓存环境下的数据一致性保障。关键策略包括Cache Aside模式与延迟双删、发布订阅的实例间通知机制、版本控制与冲突解决、差异化的业务场景处理以及完善的监控自修复机制。这些措施共同构成了一个健壮的缓存一致性保障体系，在提供高性能数据访问的同时，也最大限度地确保了数据的一致性。
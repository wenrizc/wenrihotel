
## 一、JWT基础架构设计

### 1. JWT配置中心

项目设计了专门的JWT配置中心，集中管理所有与JWT相关的参数：

- **密钥配置**：使用Base64编码的强随机密钥，支持从配置文件和环境变量加载
- **签名算法**：默认采用HS256算法，也支持HS512等更高安全级别算法
- **令牌有效期**：默认配置为24小时，支持动态调整
- **令牌前缀**：规范化的"Bearer "前缀处理
- **刷新窗口期**：设置为过期前30分钟可以刷新令牌

### 2. JWT工具类抽象

项目封装了统一的JWT工具类，提供以下核心功能：

- 令牌生成与签发
- 令牌解析与验证
- 有效期检查与计算
- 令牌刷新逻辑
- 黑名单检查逻辑

## 二、JWT生成与签发流程

### 1. 令牌构建策略

项目采用了分层的令牌构建策略：

- **Header部分**：指定算法类型（alg）和令牌类型（typ）
- **Payload部分**：包含标准声明和自定义声明
  - 标准声明：iss（签发者）、exp（过期时间）、iat（签发时间）、jti（JWT ID）
  - 自定义声明：userId（用户ID）、role（用户角色）、permissions（权限集合）

### 2. 用户数据提取

在用户登录成功后，系统会：
- 从数据库获取用户核心信息
- 剔除敏感信息（如密码）
- 构建精简的用户数据模型（仅包含必要信息）
- 将用户数据转换为JWT payload

### 3. 令牌签名与组装

- 使用配置的密钥对Header和Payload进行签名
- 组装最终的JWT字符串（Header.Payload.Signature）
- 将完整JWT存储到登录响应中返回给客户端

## 三、JWT验证与解析流程

### 1. 令牌获取策略

项目支持多种令牌获取方式：

- 优先从请求头的"Authorization"字段获取
- 尝试从请求参数"token"获取
- 尝试从Cookie中获取
- 支持自动去除"Bearer "前缀

### 2. 多级验证机制

JWT验证采用多级验证机制：

- **结构验证**：确保JWT格式正确（Header.Payload.Signature）
- **签名验证**：使用密钥验证签名是否有效
- **时效性验证**：检查JWT是否过期
- **黑名单验证**：检查JWT是否在黑名单中（用于处理登出）

### 3. 信息提取与转换

验证通过后：
- 解析Payload中的用户信息
- 将JWT中的用户数据转换为UserDTO对象
- 将用户信息存入ThreadLocal，方便业务层使用

## 四、拦截器与用户上下文管理

### 1. JWT拦截器链设计

项目实现了两个关键拦截器：

- **RefreshTokenInterceptor**：
  - 处理所有请求（/**)
  - 优先级最高（order=0）
  - 负责token解析与用户信息提取
  - 处理token刷新逻辑
  - 即使token无效也不拦截请求，仅记录用户状态

- **LoginInterceptor**：
  - 处理需要登录的请求（排除公开接口）
  - 次优先级（order=1）
  - 检查ThreadLocal中是否存在用户信息
  - 对未登录用户拦截受保护资源

### 2. 用户上下文管理

- 使用ThreadLocal存储当前请求的用户信息
- 请求处理完成后清理ThreadLocal，避免内存泄漏
- 提供静态工具类方法获取当前用户信息

## 五、JWT刷新机制

### 1. 自动续期策略

项目实现了JWT自动续期机制：

- 当用户持有的token进入刷新窗口期（过期前30分钟）
- RefreshTokenInterceptor检测到并自动生成新token
- 通过响应头返回新token给客户端
- 旧token继续有效直到过期

### 2. 静默刷新实现

- 刷新过程对用户透明，无需额外操作
- 客户端接收到新token后更新本地存储
- 无需专门的刷新令牌接口

## 六、安全防护机制

### 1. JWT黑名单

为解决JWT无法主动失效的问题，项目设计了黑名单机制：

- 使用Redis存储已登出的token
- 黑名单键格式为`token:blacklist:{token}`
- 黑名单记录的过期时间与JWT剩余有效期一致
- 每次验证时检查token是否在黑名单中

### 2. 登出实现

用户登出时：
- 从请求中获取当前token
- 计算token剩余有效期
- 将token加入Redis黑名单，有效期设为剩余时间
- 清理本地用户上下文

### 3. 防伪造措施

- JWT包含用户IP地址信息（可选）
- 验证时比对当前请求IP与token中存储IP
- 重大操作时要求二次验证

## 七、与缓存系统集成

### 1. Redis存储优化

- 仅存储必要的黑名单数据，避免Redis负担
- 使用合理的键过期策略，自动清理过期黑名单
- 针对Redis异常场景提供降级处理

### 2. 分布式一致性保障

- 多实例环境下通过Redis保障JWT黑名单的一致性
- 处理网络分区等异常情况下的降级策略

## 八、JWT安全强化措施

### 1. 敏感数据处理

- 避免在JWT中存储过多敏感信息
- 仅存储用户标识和权限相关信息
- 敏感操作时通过数据库再次验证权限

### 2. 异常处理与监控

- 完善的JWT异常处理机制，区分不同错误类型
- JWT操作异常日志记录
- 可疑JWT使用行为监控（如频繁失败尝试）

## 总结

黑马点评项目通过精心设计的JWT实现方案，构建了一套完整的用户认证与授权体系。该方案不仅解决了传统session机制在分布式环境下的局限性，还通过多级拦截器、黑名单机制、自动续期等特性，提供了安全可靠的用户身份管理。系统将JWT与ThreadLocal、Redis等技术有机结合，既保证了性能，又兼顾了安全性，为项目的用户权限管理提供了坚实基础。
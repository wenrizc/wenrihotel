
项目中的秒杀业务采用了多层次的并发安全控制机制，确保在高并发场景下系统稳定运行并保证业务正确性。主要实现思路如下：

## 流量控制层面

1. **Sentinel 限流保护**：
    
    - 针对秒杀接口设置了限流，防止过高并发请求
    - 设置了预热机制（warm up），逐渐增加接受流量
    - 引入熔断降级机制，当接口响应时间或异常率过高时自动熔断
2. **系统级保护**：
    
    - 通过 SystemMonitor 监控 CPU 和内存使用率
    - 当系统资源接近阈值时，拒绝执行非关键任务
    - 对系统负载趋势进行分析，提前预警

## 库存控制层面

1. **Redis 预减库存**：
    
    - 将热门商品库存预加载到 Redis
    - 使用 Lua 脚本保证库存检查和扣减的原子性
    - 通过异步机制将 Redis 的库存变更同步到数据库
2. **数据库乐观锁**：
    
    - 对秒杀券使用 CAS 操作（条件更新）保证库存不会超卖

## 一人一单控制

1. **Redis 集合去重**：
    
    - 使用 Redis 集合记录已下单用户
    - 在 Lua 脚本中原子性检查用户是否已下单并记录
2. **数据库唯一索引**：
    
    - 通过用户ID和优惠券ID的唯一索引约束防止重复下单

## 异步处理机制

1. **消息队列**：
    
    - 使用 Redis Stream 作为消息队列
    - 秒杀成功后发送消息到队列，异步创建订单
2. **异步库存更新**：
    
    - Redis 预减库存后异步更新数据库
    - 通过 asyncUpdateStock 方法实现

## 系统稳定性保障

1. **布隆过滤器**：
    
    - 提前判断不存在的商品，减轻系统负担
    - 定期重建以保持准确性
2. **资源监控自适应**：
    
    - 根据系统负载动态调整可执行任务
    - 高负载时推迟非关键任务执行
    - 设置多级预警阈值，及时发现系统压力
3. **分布式锁**：
    
    - 在一些关键操作上使用分布式锁确保并发安全：秒杀下单 库存同步 缓存重建

## 一、多级缓存架构

### 1. 分层缓存设计
项目采用了"本地缓存 + Redis分布式缓存 + 数据库"的三级缓存架构：
- **本地缓存层**：使用Caffeine实现，最大容量10000条，默认60秒过期
- **Redis分布式缓存层**：存储共享数据，并根据数据热度设置不同的过期策略
- **数据库层**：作为最终数据源，当缓存未命中或失效时提供数据支持

### 2. 统一缓存管理
通过`UnifiedCache`类统一管理所有缓存操作，提供一致的接口，确保缓存策略的一致性和可维护性。该组件支持多种缓存模式，并能根据业务场景智能选择最优缓存策略。

### 3. 差异化缓存策略
- **普通数据**：采用简单的KV结构，设置随机过期时间避免缓存雪崩
- **热点数据**：使用逻辑过期方案，结合后台异步更新机制，有效防止缓存击穿
- **无效数据**：缓存空值（设置较短的过期时间），防止缓存穿透

## 二、布隆过滤器优化

### 1. 业务隔离的布隆过滤器
为不同业务（如商铺、优惠券、博客等）维护独立的布隆过滤器，根据各自特点设置不同的容量和误判率：
- 查询频繁的商铺数据：0.001误判率
- 博客等查询较少的数据：0.01误判率
- 其他业务类型：0.005误判率

### 2. 动态重建机制
- 监控布隆过滤器的删除操作比例，当达到阈值（不同业务有不同阈值，如商铺5%，博客15%）时触发重建
- 通过XXL-Job定时任务支持全量重建和分业务类型重建
- 重建过程支持分片执行，避免单次重建带来的系统压力

### 3. 精细化统计监控
- 维护命中率、误判率等关键性能指标
- 定期监控布隆过滤器健康状态，当误判率超过10%时发出告警

## 三、热点数据预处理

### 1. 热点探测与自适应升级
- 实现`TicketHeatManager`监控数据访问频率，识别热点数据
- 当数据访问量达到阈值（如100次）时，自动标记为热点数据
- 热点数据采用更长的缓存时间（30分钟 vs 10分钟）和不同的缓存策略

### 2. 热点数据预热
- 系统启动时通过`TicketPreloadRunner`预热已知热点数据
- 定时任务`CacheMaintenanceJob`定期重新评估并预热热点数据
- 针对新晋热点数据，主动加载到缓存，并预热相关联数据（如SKU、库存）

### 3. 热点降级机制
- 定期评估数据热度，对不再热门的数据进行降级处理
- 降级时清除特殊缓存策略，使其恢复为普通数据处理方式

## 四、限流与熔断保护

### 1. 精细化流量控制
通过Sentinel实现多维度的流量控制：
- **接口级别流控**：针对秒杀接口的QPS限制
- **资源级别流控**：针对下单接口基于并发线程数控制，设置为阈值的80%提前预防
- **系统级别流控**：针对整体CPU利用率和系统负载的全局控制

### 2. 熔断降级策略
- **基于响应时间**：对秒杀接口设置100ms响应时间阈值，超过后熔断10秒
- **基于异常比例**：对下单接口设置20%异常率阈值，超过后熔断30秒
- 熔断触发后自动返回友好提示，避免系统崩溃

### 3. 塌陷点防护
- 特别针对1600线程塌陷点进行优化（JVM线程饥饿临界点）
- 系统规则设置最大线程数2200，确保系统整体稳定性
- 通过SentinelConfig动态配置限流规则，支持云端调整

## 五、异步处理与线程池优化

### 1. 专用线程池隔离
- 为缓存重建等重要异步任务创建专用线程池（固定16线程）
- 隔离不同类型的任务，避免相互影响

### 2. 异步缓存更新
- 热点数据使用逻辑过期时，通过异步线程更新缓存
- 线程获取分布式锁后后台执行缓存重建，不阻塞用户请求

### 3. 延迟任务处理
- 通过XXL-Job执行订单状态自动迁移
- 支持分片执行，提高处理效率
- 处理超时未支付订单自动取消、长期退款申请订单自动关闭等场景

## 六、分布式任务调度

### 1. 基于XXL-Job的任务框架
- 实现分片执行的定时任务，支持大数据量处理
- 支持参数化配置，可根据实际需求调整任务行为
- 完整的任务执行监控和日志记录

### 2. 核心定时任务
- **缓存维护任务**：清理过期缓存、预热热点数据
- **布隆过滤器重建任务**：全量重建或分业务类型重建
- **门票热度评估任务**：定期分析数据热度并调整缓存策略
- **订单状态迁移任务**：处理订单生命周期中的状态转换

### 3. 系统负载感知
- 大型任务执行前检查系统负载情况
- 在高负载情况下延迟执行非关键任务
- 任务间增加随机延迟，避免同时开始导致的资源竞争

## 七、系统监控与自适应控制

### 1. 实时系统状态监控
- `SystemMonitor`组件定期监控CPU、内存使用率及系统负载
- 设置预警和临界阈值（如CPU 80%、内存 85%）
- 监控线程数、系统负载等多维度指标

### 2. 自适应执行控制
- 根据系统负载状态，自动调整任务执行策略
- 高负载时推迟非关键任务执行
- 记录历史负载数据，分析负载趋势，预判系统风险

### 3. 全面性能指标
- 缓存命中率、布隆过滤器误判率等关键指标监控
- 通过API接口暴露监控数据，支持接入监控平台
- 提供系统状态可视化描述，便于运维人员快速了解系统情况

## 八、分布式锁与一致性保障

### 1. 分布式锁机制
- 使用Redis实现分布式锁，防止并发操作导致的数据不一致
- 锁超时自动释放，避免死锁
- 支持可重入性，提高代码可维护性

### 2. 缓存一致性维护
- 通过消息通知机制处理缓存变更
- 支持跨节点缓存一致性保障
- 本地缓存与Redis缓存同步失效

## 总结

通过多级缓存、布隆过滤器、热点数据处理、限流熔断、线程池优化、分布式任务以及系统监控等综合手段，构建了一套完善的高并发性能优化体系。这些优化措施不仅解决了缓存穿透、缓存击穿、缓存雪崩等典型缓存问题，还针对资源竞争、热点数据、系统过载等高并发场景提供了全面防护，确保系统在高负载情况下依然能够稳定、高效地运行，为用户提供良好的服务体验。

## 1. 倒排索引（核心数据结构）

Elasticsearch的搜索核心是**倒排索引**（Inverted Index），与传统数据库不同：
- 传统数据库：文档 → 内容（正排）
- Elasticsearch：词条 → 文档（倒排）

倒排索引结构：
```
词条A → 文档1, 文档3, 文档7...
词条B → 文档2, 文档4, 文档9...
```

这使得ES可以极快地回答"哪些文档包含特定词条"的问题。

## 2. 分词与分析过程

文档索引流程：
1. **字符过滤**：移除HTML标记等
2. **分词**：将文本拆分成单词/词元
3. **标记过滤**：转换为小写、去除停用词、词干提取等
4. **构建倒排索引**：记录词条与文档的映射关系

ES支持多种分析器（Analyzer），如Standard、Simple、Whitespace等。

## 3. 查询执行与评分

1. **查询解析**：将用户查询转换为查询树
2. **查询类型**：
   - 词条查询（term query）：精确匹配
   - 全文查询（match query）：先分析再匹配
   - 布尔查询：组合多个查询条件
   - 范围查询：数值、日期范围
   
3. **相关性评分**：使用TF-IDF或BM25算法
   - TF（词频）：词在文档中出现的频率
   - IDF（反文档频率）：衡量词的稀有程度
   - 文档长度归一化：调整长文档的权重

## 4. 分布式架构

ES搜索分布式实现：
1. **索引分片**：将索引分成多个分片，分布在不同节点
2. **查询协调**：
   - 请求分发：协调节点将查询发送到所有相关分片
   - 结果聚合：收集各分片结果，合并、排序、分页
3. **近实时搜索**：利用内存缓冲区和定期刷新机制

## 5. 性能优化技术

- **索引优化**：字段映射、分析器选择
- **过滤器缓存**：常用过滤结果缓存
- **预索引数据**：对常见查询提前计算
- **字段数据缓存**：优化聚合和排序
- **Doc Values**：列式存储优化聚合操作
- **压缩算法**：减少索引大小和I/O开销

## 6. 高级搜索功能

- **模糊搜索**：基于编辑距离的纠错能力
- **同义词**：扩展查询以包含同义词
- **n-gram/edge n-gram**：支持前缀、后缀搜索
- **地理空间搜索**：支持地理位置查询
- **向量搜索**：支持基于向量的相似性搜索




在本项目中，Sentinel的限流规则采用了混合方式实现，既有固定规则，也有动态调整机制。

## 限流规则配置方式

1. **固定规则配置**：
   - 通过`SentinelConfig`类中的初始化方法配置基础限流规则
   - 系统启动时加载配置文件`sentinel-rules.yml`中定义的默认规则
   - 核心接口如门票查询、订单创建有预设的QPS限制值

2. **动态调整规则**：
   - 系统实现了`SentinelRuleManager`类负责规则的动态调整
   - 规则可以根据系统负载和访问模式自动调整
   - 修改后的规则会持久化到配置中心，确保集群一致性

## 限流指标及阈值

Sentinel限流规则主要基于以下指标进行判断：

1. **QPS指标**：
   - 基于资源(如API接口)的每秒查询数
   - 热门接口如`/vouchers/{id}`的QPS限制较高(默认为200)
   - 一般接口限制较低(默认为50)

2. **并发线程数**：
   - 针对耗时操作(如下单流程)设置最大并发线程数
   - 避免线程资源耗尽导致系统崩溃

3. **系统负载指标**：
   - 当系统CPU使用率超过阈值(默认80%)时，触发系统保护规则
   - 通过`SystemRuleManager`实现自适应限流

4. **热点参数限流**：
   - 针对门票ID等热点参数实现更精细的限流
   - 热门门票ID的访问限制更严格，普通ID限制较宽松

## 动态调整触发条件

系统会根据以下情况动态调整Sentinel规则：

1. **定时评估触发**：
   - 每隔5分钟执行一次规则评估
   - 由`SentinelRuleEvaluationTask`定时任务实现

2. **流量突变触发**：
   - 监测到某资源流量突增(超过正常值的3倍)时
   - 立即提高相应资源的限流阈值，预防可能的流量高峰

3. **错误率触发**：
   - 当某资源错误率超过5%时，降低其限流阈值
   - 防止系统在异常状态下继续承受高负载

4. **手动触发**：
   - 管理员可通过`SentinelAdminController`实时调整规则
   - 在促销活动前手动提高特定接口的阈值

## 规则持久化与集群同步

1. **规则持久化**：
   - 使用Redis存储当前生效的规则集
   - 键名格式为`sentinel:rules:{ruleType}`

2. **集群同步**：
   - 通过Redis的发布订阅机制实现规则变更通知
   - 确保集群中所有节点规则一致性

通过这种灵活的限流规则管理机制，系统能够在保证稳定运行的同时，最大程度地提高资源利用率，特别是在访问量波动较大的场景下表现出色。
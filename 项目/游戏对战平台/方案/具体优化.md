
网关基于责任链模式，采用SPI机制实现插件，使用webflux优化性能，阻塞操作采用虚拟线程，暂时只需要实现为后端单体提供接入层功能，但要保持高可拓展性，可以为后续微服务化打下基础，同时路由转发功能采用选择器+规则匹配模式，网关实现参考并攫取知名开源网关设计的精华，同时注意网关设计需要保持轻量化，暂时只需要支持编写配置文件配置网关，同时对插件系统应优化性能，给出完整的网关设计方案，不要给代码，重点在于讲述架构设计和思路实现


单聊，房间内聊天，大厅聊天，采用写放大模式

持久化等操作通过消息队列实现

历史消息拉取采用信令模式

针对大量离线消息的到来导致客户端卡顿的问题，采用推拉结合的消息同步策略：登录时仅推送少
量最近消息和未读消息计数，用户进入会话后按需分页拉取历史消息。

该心跳优化方案首先通过三次短心跳确保初始网络稳定，随后以指数递增方式探测最大心跳连接时长，其中单次成功即初步认定间隔可行，而需连续多次失败才确认间隔不可行或网络异常。为避免NAT超时临界点，最终采用的心跳间隔会略小于探测到的最大成功值，并具备动态调整机制，如定期重探或失败后重新计算，以持续校正和优化。

设置一个阈值，在检测到新到来消息过于密集时，会升级，为应对大厅聊天短时间内大量消息写入导致的消息风暴，服务器选择推送一个通知信令，客户端收到此信令后，旁路主动拉取批量的、经过压缩的实际聊天消息数据，避免了海量数据拥塞长连接，保障了其他关键实时消息的低延迟。

该方案的核心是通过**消息队列（MQ）机制**，实现了消息处理流程的异步化、模块化和高效扇出
1. **第一级MQ ：实现消息的初步接收、持久化与预处理的解耦。**
2. **第二级MQ：实现消息推送逻辑与实际分发执行的解耦，并利用发布订阅模型进行高效扇出。**

为保障在网络波动环境的消息可靠投递，避免消息乱序、重复和丢失问题，在应用层设计了完整的消
息确认机制，并结合重试机制确保消息不会丢失，同时在服务器采用 Redis INCR 生成全局递增序列
号实现消息排序，在客户端维护消息 id 缓存池进行去重处理。
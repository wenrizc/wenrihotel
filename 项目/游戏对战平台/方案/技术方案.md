
### 1. 项目概述与目标

本项目旨在构建一个集用户管理、实时聊天（大厅/房间）、游戏房间管理以及通过集成Tailscale/Headscale实现远程联机对战局域网游戏的多功能平台。平台需具备高并发处理能力、良好的可扩展性、稳定可靠的实时通讯以及流畅的用户体验。

---

### 2. 设计原则

*   **异步化与解耦**：核心业务流程采用异步设计，通过消息队列解耦服务，提升系统吞吐量、响应速度和故障隔离能力。
*   **缓存优先**：对高频访问数据和计算结果进行有效缓存，降低持久化存储压力，提升响应速度。
*   **用户体验至上**：优化实时同步、离线消息、弱网连接、消息去重与有序性，保障流畅通信。

---

### 3. 架构总览

平台采用分层架构，各层职责明确，通过标准接口和消息队列进行协作。

1.  **客户端层 (Client Tier)**：
    *   **技术**: Go语言, Wails (内嵌Web前端技术), `tailscale/tsnet`库, SQLite。
    *   **职责**: 提供用户交互界面，处理本地业务逻辑，通过WebSocket与网关层进行实时通信，集成`tsnet`实现VPN功能，使用SQLite进行本地数据缓存。
2.  **接入与网关层 (Access & Gateway Tier)**：
    *   **技术**: Spring WebFlux 自定义反应式网关, Sa-Token。
    *   **职责**: 系统统一流量入口。处理HTTP请求路由、安全认证、限流熔断、管理WebSocket连接，各项功能通过插件实现，同时通过RPC调用后端应用层。
3.  **后端应用层 (Backend Application Tier)**：
    *   **技术**: Spring Boot, Spring MVC, MyBatis-Plus。
    *   **职责**: 单体应用，与数据库、缓存交互，实现各项业务功能
4.  **缓存层 (Caching Tier)**：
    *   **技术**: Redis。
    *   **职责**: 存储热点数据（用户信息、房间列表、最近聊天）、用户在线状态、分布式锁等，提升性能。
5.  **持久化存储层 (Persistence Tier)**：
    *   **技术**: MySQL。
    *   **职责**: 存储所有业务实体数据（用户、好友、房间、聊天记录）和平台元数据。
6.  **虚拟网络控制层 (VPN Control Tier)**：
    *   **技术**: Headscale (Go), WireGuard。
    *   **职责**: 独立部署，作为Tailscale的开源控制平面，管理虚拟网络中的节点和访问策略，支撑远程联机。

---

### 4. 技术栈选型

| 层次/功能           | 选型技术 & 开源项目                                    | 作用与核心考量                                       |
| :-------------- | :--------------------------------------------- | :-------------------------------------------- |
| **客户端**         | `Go`, `Wails`, `tailscale/tsnet`, `SQLite`     | 跨平台GUI，Go负责核心逻辑与`tsnet`VPN集成，SQLite本地缓存。      |
| **网关层**         | `Spring WebFlux`, `Project Reactor`, `satoken` | **反应式API网关**：统一入口，鉴权，HTTP路由。。                 |
| **后端应用 (Java)** | `Spring Boot`, `Spring MVC`, `MyBatis-Plus`    | **核心业务逻辑处理**：与DB/Cache交互，回传。                  |
| **消息队列**        | `RabbitMQ`                                     | 异步解耦，可靠传递。                                    |
| **核心缓存/状态**     | `Redis`                                        | 高性能内存存储：热点数据缓存，**用户在线状态及连接GatewayID维护**，分布式锁。 |
| **持久化存储**       | `MySQL`                                        | 关系型数据库：持久化用户数据、关系、房间信息、聊天记录等。                 |
| **虚拟网络**        | `Headscale` (Go), `WireGuard`                  | 开源Tailscale控制服务，`WireGuard`底层VPN协议。实现P2P远程联机。 |
| **通信协议**        | `Protobuf`                                     | 高效二进制序列化                                      |

---

### 5. 核心模块与功能

#### 5.1. 客户端模块
*   **UI与交互**: 使用Wails构建跨平台界面，前端技术栈（HTML/CSS/JS）与Go后端逻辑交互。
*   **核心功能**:
    *   用户认证（注册、登录、登出）。
    *   个人资料与好友管理。
    *   实时聊天（单聊、群聊、大厅、房间内），支持消息收发、历史消息加载。
    *   游戏房间浏览、创建、加入、退出。
    *   **远程联机**: 集成`tsnet`，连接到Headscale管理的虚拟网络，获取虚拟IP，实现P2P游戏数据传输。
    *   **本地存储 (SQLite)**: 缓存聊天记录、用户配置、消息状态。
*   **通信**:
    *   通过HTTP(S)调用网关API执行非实时操作。
    *   通过WebSocket与网关建立长连接，收发Protobuf序列化的实时消息和信令。
    *   实现心跳保活、消息ACK（发送确认、接收确认）、消息去重。

#### 5.2. API网关模块 (Spring WebFlux)
*   **核心职责**:
    *   **统一入口**: HTTP/HTTPS API路由转发至后端应用服务。
    *   **WebSocket管理**:
        *   处理客户端WebSocket连接建立、认证、维护和关闭。
    *   **安全防护**: Sa-Token身份认证、API限流、熔断。
    *   **协议转换**: 在WebSocket和MQ消息之间进行协议和格式转换。

#### 5.3. 后端应用模块 (Spring Boot/MVC Monolith)
作为单体应用，内部按职责划分为不同服务组件

*   **5.3.1. 用户服务**
    *   **功能**: 用户注册、登录、资料管理、好友关系管理。
    *   **交互**: 提供HTTP API供网关调用，更新Redis中的用户在线状态和GatewayID。
    *   **数据**: 用户信息、好友关系存入MySQL；热点用户信息、好友列表ID缓存于Redis。

*   **5.3.2. 房间服务**
    *   **功能**: 游戏房间的创建、加入、退出、列表查询、状态管理。
    *   **交互**: 提供HTTP API供网关调用；当房间状态或成员变更时发布通知事件，以便推送给相关用户。
    *   **数据**: 房间信息、成员关系存入MySQL；房间列表、详情、实时成员缓存于Redis。
    *   **联机协同**: 与VPN管理服务交互，为房间成员配置虚拟网络访问权限。

*   **5.3.3. IM服务 (核心消息处理)**
    *   **功能**:
        *   处理单聊、群聊（包括大厅、游戏房间内）消息的收发逻辑。
        *   消息持久化（MySQL）、消息ID与序列号生成。
        *   历史消息拉取（提供HTTP API）。
        *   离线消息存储与推送。
        *   处理客户端消息ACK。
        *   **大厅等高并发场景优化**: 可采用轻量级新消息通知 + 客户端主动拉取策略。
    *   **数据**: 聊天记录存入MySQL；会话最新消息、用户在线状态及GatewayID依赖Redis。

*   **5.3.5. VPN管理服务**
    *   **功能**: 封装与Headscale服务的API交互，管理虚拟网络节点、预授权密钥、ACL策略、节点Tag等。
    *   **交互**: 供房间服务等内部服务调用，以实现游戏联机时的网络配置自动化。
    *   **数据**: Headscale节点与平台用户的映射关系可能需存入MySQL。

#### 5.4. 缓存模块 (Redis)
*   **核心数据与功能**:
    *   **用户在线状态**: 
    *   **热点业务数据**: 用户信息、好友列表、房间列表、房间详情、最近聊天记录片段。
    *   **序列号生成**: 如会话内消息的自增序列号。
    *   **临时数据**: 如验证码

#### 5.5. 持久化存储模块 (MySQL)
*   **核心数据**:
    *   用户账户信息、密码哈希、个人资料。
    *   好友关系、群组成员关系。
    *   游戏房间配置、房间成员。
    *   **聊天记录**: 包含发送者、接收者/群组、消息内容、类型、时间戳、服务端消息ID、会话序列号等。
    *   Headscale节点与平台用户的关联信息（如果需要）。
    *   系统配置、审计日志等。

#### 5.6. 虚拟网络控制模块 (Headscale)
*   **核心功能**:
    *   **节点管理**: 注册和管理客户端（玩家）的`tsnet`节点。
    *   **网络隔离与互通**: 通过ACL（访问控制列表）和Tags，精确控制哪些节点之间可以相互通信。例如，同一游戏房间的玩家节点可以被赋予相同Tag，并配置ACL允许这些Tag的节点互通。
    *   **NAT穿透**: 利用Tailscale/WireGuard的NAT穿透能力，辅助玩家建立P2P连接。可选配置DERP中继服务器改善连接成功率。



#### 理论上的单表行数限制

1.  单表的行数上限主要由主键的数据类型决定。
    *   如果主键是 `int` 类型（32位），最大支持约 21 亿行。
    *   如果主键是 `bigint` 类型（64位），支持的行数巨大，在实践中几乎不可能达到该上限。

#### InnoDB 存储结构基础

1.  表空间 (Tablespace)：
    *   InnoDB 的表数据存储在一个 `.ibd` 文件中，这个文件被称为表空间。
    *   数据在文件中不是连续存储的，而是被划分成多个数据页。

2.  页 (Page)：
    *   页是 InnoDB 存储和 I/O 的基本单位，每个页的大小固定为 16KB。
    *   页的内部结构分为多个部分，其中用户记录存储在 `User Records` 区域，这部分空间是从 `Free Space` 区域动态申请的。当页被写满，就需要申请新的页。

3.  索引的数据结构 (B+ 树)：
    *   InnoDB 使用 B+ 树作为索引结构，B+ 树的每一个节点就是一个页（大小同样为 16KB）。
    *   节点分为两类：
        *   非叶子节点 (索引页)：不存储实际的行数据。它们存放的内容是 “主键的最小值” 和 “指向下一层节点的页号（指针）”，作为目录使用。
        *   叶子节点 (数据页)：存储了实际的行数据。在 B+ 树中，它们位于最底层（level=0）。

#### 2000万行建议值的推算过程

1.  查询过程：查找一条数据时，从 B+ 树的根节点开始，通过逐层比较主键值，最终定位到包含目标数据的叶子节点。这个过程的磁盘 I/O 次数约等于 B+ 树的高度。

2.  容量估算公式：一个 B+ 树能容纳的总行数 `Total` 可以通过以下公式估算：
    `Total = x^(z-1) * y`
    *   `x`: 代表一个非叶子节点（索引页）能容纳的指针数量。
    *   `y`: 代表一个叶子节点（数据页）能容纳的行数据数量。
    *   `z`: 代表 B+ 树的层数（高度）。

3.  计算 `x` (非叶子节点的指针数)：
    *   一个页大小为 16KB，除去固定的头尾等开销（约1KB），还剩 15KB 可用空间。
    *   非叶子节点中一条索引记录由 “主键 (假设为 BIGINT, 占 8 字节)” 和 “页号 (占 4 字节)” 组成，共 12 字节。
    *   `x = (15 * 1024) / 12 ≈ 1280` 个指针。

4.  计算 `y` (叶子节点的数据行数)：
    *   叶子节点同样有约 15KB 的可用空间。
    *   `y` 的值取决于单行数据的大小。假设平均每行数据占用 1KB。
    *   `y = (15 * 1024) / 1000 ≈ 15` 行。

5.  计算总行数：
    *   通常，为了保证查询性能（较少的 I/O），B+ 树的高度不宜过高，一般为 2 到 3 层。
    *   当 `z = 2` (两层树): `Total = 1280^1 * 15 = 19,200` 行。
    *   当 `z = 3` (三层树): `Total = 1280^2 * 15 = 24,576,000` 行 (约 2457 万)。

6.  结论的由来：
    *   这个约 2457 万的计算结果，与业界流传的 2000 万建议值非常吻合。这说明该建议值是基于“希望 B+ 树的层高保持在3层以内”这一性能考量而得出的一个估算值。

7.  重要补充：
    *   这个建议值不是绝对的。它严重依赖于 `y` 的值，即单行数据的大小。
    *   例如，如果单行数据占用空间较大（如5KB），那么一个叶子页只能存放 `15KB / 5KB = 3` 条数据。此时，一个 3 层 B+ 树能存放的总行数约为 `1280^2 * 3 ≈ 491` 万行。
    *   因此，行数据越小，单表能支撑的行数就越多；反之则越少。

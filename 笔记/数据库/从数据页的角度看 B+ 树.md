
####  InnoDB 存储数据

1.  基本单位：
    *   InnoDB 存储引擎不以“行”为单位进行磁盘读写，而是以“数据页”为单位。
    *   数据页是数据库 I/O 操作的最小单位。
    *   默认的数据页大小为 16KB。这意味着每次读写操作，至少会从磁盘读取 16KB 的内容到内存，或将 16KB 的内容从内存刷新到磁盘。

2.  数据页的结构：
    *   一个数据页由七个部分组成：文件头（File Header）、页头（Page Header）、最小和最大记录（Infimum + Supremum Records）、用户记录（User Records）、空闲空间（Free Space）、页目录（Page Directory）、文件尾（File Trailer）。

3.  数据页之间的连接：
    *   每个数据页的“文件头”部分包含指向上一个和下一个数据页的指针。
    *   通过这两个指针，所有数据页在逻辑上形成一个双向链表，即使它们在物理存储上不是连续的。

4.  数据页内部的记录组织：
    *   用户记录区（User Records）：页内的记录按照主键顺序组成一个单向链表。这种结构便于插入和删除，但直接遍历查找效率低。
    *   页目录（Page Directory）：为了提高页内查找效率，InnoDB 设计了页目录，它相当于记录的索引。

5.  页目录的创建与工作原理：
    *   创建过程：
        1.  将页内所有有效记录（不包括已删除记录）划分为若干个组。
        2.  每个组的最后一条记录（即组内主键最大的记录）的头信息里，会存储该组的记录总数（n_owned 字段）。
        3.  页目录中存储每个组“最后一条记录”的地址偏移量，这个地址偏移量被称为“槽”（slot）。
    *   查找过程：
        1.  由于槽是按主键顺序排列的，可以通过二分法在页目录中快速定位记录所在的槽（分组）。
        2.  定位到槽之后，由于槽内记录数量很少，再从该组的第一个记录开始遍历，找到目标记录。
        3.  要找到一个组的起始记录，可以先找到前一个槽对应的记录，其下一条记录就是当前组的起始记录。
    *   分组记录数规定：
        *   第一个分组只有 1 条记录。
        *   最后一个分组有 1-8 条记录。
        *   其余分组有 4-8 条记录。这个规定保证了槽内遍历的效率。

#### B+ 树如何进行查询？

1.  背景：当数据量增大，需要多个数据页存储时，就需要一个高效的索引来定位记录所在的数据页。InnoDB 采用 B+ 树作为索引结构。

2.  B+ 树的特点：
    *   InnoDB 中的 B+ 树，其每一个节点都是一个数据页。
    *   非叶子节点（上层节点）只存储目录项（索引键和指向下一层节点的指针），不存储实际的用户数据。
    *   只有叶子节点（最底层节点）才存放真正的用户记录。
    *   所有叶子节点通过指针连接成一个双向链表，便于进行范围查询。
    *   B+ 树结构通常“矮胖”，减少了树的高度，从而减少了磁盘 I/O 次数。

3.  查询流程（以查找主键为 6 的记录为例）：
    1.  从 B+ 树的根节点（一个数据页）开始，通过二分法查找，确定主键 6 所在的范围，找到指向下一层非叶子节点（如页30）的指针。
    2.  在非叶子节点（页30）中，继续通过二分法查找，确定主键 6 所在的范围，找到指向叶子节点（如页16）的指针。
    3.  在叶子节点（页16）中，使用页目录的二分法定位到记录所在的分组（槽），然后遍历该分组内的几条记录，最终找到主键为 6 的记录。

#### 三、 聚簇索引和二级索引

1.  定义与区别：索引根据其叶子节点存放的内容，分为聚簇索引和二级索引。
    *   聚簇索引（Clustered Index）：叶子节点存放的是完整的用户记录（实际数据）。
    *   二级索引（Secondary Index）：叶子节点存放的不是实际数据，而是记录的“主键值”。

2.  聚簇索引的特性：
    *   由于数据行本身就存放在聚簇索引的叶子节点中，因此一个表只能有一个聚簇索引。
    *   InnoDB 会自动为每个表创建聚簇索引，选择索引键的顺序如下：
        1.  若有主键，则使用主键。
        2.  若无主键，则选择第一个不含 NULL 值的唯一列。
        3.  若以上两者都没有，InnoDB 会自动生成一个隐藏的自增 id 列作为索引键。

3.  二级索引的特性与查询过程：
    *   一个表可以拥有多个二级索引，用于加快非主键字段的查询。
    *   二级索引同样是 B+ 树结构。
    *   回表（Back-to-Table）：如果一个查询使用了二级索引，并且需要获取的列不在二级索引中（即非主键列），查询过程会分为两步：
        1.  先在二级索引树中查找到对应的主键值。
        2.  再用这个主键值去聚簇索引树中查找，最终获取到完整的记录行。这个需要查询两次 B+ 树的过程就叫“回表”。
    *   索引覆盖（Index Covering）：如果查询所需的所有数据（例如只查询主键或被索引的列）都能在二级索引的叶子节点中直接获取，那么就不需要再查询聚簇索引。这个过程只需查询一次 B+ 树，称为“索引覆盖”，效率更高。

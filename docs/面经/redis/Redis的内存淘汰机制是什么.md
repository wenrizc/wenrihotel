
Redis的内存淘汰机制（Eviction Policy）是指当Redis的已用内存达到其配置的最大内存限制（`maxmemory`配置项）时，为了能够继续接收新的写命令并存储新的数据，Redis需要从已有的键值对中选择一些“不那么重要”的键进行删除，以释放内存空间。

Redis提供了多种不同的内存淘汰策略，用户可以根据应用的特点和需求在配置文件（`redis.conf`）中通过 `maxmemory-policy` 参数进行设置。

以下是Redis主要的内存淘汰策略：

1.  `noeviction`（默认策略）：
    *   当内存使用达到`maxmemory`限制时，不进行任何淘汰。
    *   对于所有可能导致内存增加的写命令（如`SET`, `LPUSH`, `HSET`等），Redis会直接返回错误信息（例如，OOM command not allowed when used memory > 'maxmemory'）。
    *   读命令（如`GET`）仍然可以正常执行。
    *   这种策略适合于那些希望严格控制内存使用，并且当内存不足时宁愿报错也不愿丢失任何数据的应用。

2.  `allkeys-lru`：
    *   LRU (Least Recently Used - 最近最少使用) 策略，应用于所有的键（all keys）。
    *   当内存不足时，Redis会尝试从所有键中，移除最近最少被访问过的键。
    *   Redis并非实现了一个精确的LRU算法（因为精确LRU需要维护所有键的访问顺序，开销较大），而是采用了一种近似LRU的算法：随机采样N个键（N可配置，默认为5），然后从这N个键中淘汰最近最少使用的那个。可以通过调整采样数量来平衡精度和性能。

3.  `allkeys-lfu` (Redis 4.0+):
    *   LFU (Least Frequently Used - 最不常用) 策略，应用于所有的键。
    *   当内存不足时，Redis会尝试从所有键中，移除访问频率最低的键。如果访问频率相同，则优先移除最近最少使用的键。
    *   LFU同样是近似实现，它为每个对象维护一个访问计数器和一个上次访问时间戳，并结合一个衰减机制来处理访问模式的变化。

4.  `allkeys-random`：
    *   随机策略，应用于所有的键。
    *   当内存不足时，Redis会从所有键中随机选择一些键进行删除。
    *   这种策略简单，但可能导致一些重要的数据被意外删除。

5.  `volatile-lru`：
    *   LRU策略，但只应用于设置了过期时间（TTL, Time To Live）的键（volatile keys）。
    *   当内存不足时，Redis会从所有设置了过期时间的键中，移除最近最少被访问过的键。
    *   如果所有设置了过期时间的键都无法淘汰（例如，都被频繁访问），或者没有设置过期时间的键，那么行为会退化为`noeviction`。

6.  `volatile-lfu` (Redis 4.0+):
    *   LFU策略，但只应用于设置了过期时间的键。
    *   当内存不足时，Redis会从所有设置了过期时间的键中，移除访问频率最低的键（同样考虑最近访问时间）。

7.  `volatile-random`：
    *   随机策略，但只应用于设置了过期时间的键。
    *   当内存不足时，Redis会从所有设置了过期时间的键中随机选择一些键进行删除。

8.  `volatile-ttl`：
    *   TTL策略，只应用于设置了过期时间的键。
    *   当内存不足时，Redis会从所有设置了过期时间的键中，选择那些剩余生存时间（TTL）最短的键进行优先删除。
    *   这种策略关注的是键的“即将过期”程度。

如何选择淘汰策略：

*   如果应用中的数据都有相似的访问模式，或者不确定哪种更好，`allkeys-lru` 通常是一个不错的起点。
*   如果应用中有些数据比其他数据更重要（例如，持久化配置 vs 临时缓存），并且不希望重要数据被淘汰，可以考虑将重要数据不设置过期时间，然后使用 `volatile-lru` 或 `volatile-lfu` 等策略，这样只会淘汰那些设置了过期时间的缓存数据。
*   如果应用中数据的访问频率更能代表其重要性，`allkeys-lfu` 或 `volatile-lfu` 可能更合适。LFU能更好地处理偶发性访问不应导致数据长期驻留缓存的情况。
*   `volatile-ttl` 适合于那些希望优先清除即将过期数据的场景。
*   `noeviction` 适合于严格控制内存，不允许数据丢失的场景，但需要应用层处理内存不足的错误。
*   随机策略通常在对数据重要性没有明显区分，且希望实现简单时考虑，但其效果可能不稳定。

重要提示：
*   设置`maxmemory`：要使内存淘汰机制生效，必须首先在Redis配置文件中设置 `maxmemory` 参数，指定Redis可以使用的最大内存量。
*   监控：需要监控Redis的内存使用情况、淘汰次数、以及因`noeviction`策略导致的写命令失败次数等指标，以便及时调整策略或扩容。

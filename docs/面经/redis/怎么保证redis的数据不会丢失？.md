
以下是关于“如何保证 Redis 数据不会丢失”的简单、清晰回答，聚焦关键事实，并适当延伸以符合面试场景需求：

---

### 答案
Redis 是一个内存数据库，默认数据存储在内存中，断电或进程重启可能丢失数据。要保证数据不丢失，需结合**持久化机制**（RDB 和 AOF）、**高可用架构**（主从复制、Sentinel、Cluster）和**运维策略**（备份、监控），实现数据的可靠性和持久性。

#### 核心方法
1. **RDB 持久化**：定期快照内存数据到磁盘。
2. **AOF 持久化**：记录写操作日志，故障后重放恢复。
3. **主从复制**：多节点备份数据。
4. **运维保障**：定期备份、异常检测。

---

### 1. Redis 数据丢失场景
- **断电/重启**：内存数据清空。
- **进程崩溃**：未持久化的数据丢失。
- **主节点故障**：无副本时数据不可用。
- **误操作**：如 `FLUSHALL` 删除数据。

---

### 2. 保证数据不丢失的方法
#### (1) RDB 持久化
- **原理**：
  - 将内存数据生成快照（`.rdb` 文件），保存到磁盘。
- **触发方式**：
  - 手动：`SAVE`（阻塞）或 `BGSAVE`（后台）。
  - 自动：配置文件 `save <seconds> <changes>`。
    - 如 `save 60 1000`（60 秒内 1000 次变更触发）。
- **配置**：
```conf
save 900 1
save 300 10
save 60 10000
dir /data/redis/
dbfilename dump.rdb
```
- **恢复**：
  - 重启时加载 `.rdb` 文件。
- **优点**：
  - 文件小，恢复快。
- **缺点**：
  - 快照间隔内数据可能丢失。

#### (2) AOF 持久化
- **原理**：
  - 记录每条写命令（如 `SET key value`）到日志文件（`.aof`）。
  - 重启时重放命令恢复数据。
- **同步策略**：
  - `appendfsync always`：每条命令同步（最安全，性能低）。
  - `appendfsync everysec`：每秒同步（默认，平衡）。
  - `appendfsync no`：系统决定（不安全）。
- **配置**：
```conf
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
dir /data/redis/
```
- **AOF 重写**：
  - 定期执行 `BGREWRITEAOF`，压缩日志。
- **优点**：
  - 数据丢失少（最少 1 秒）。
- **缺点**：
  - 文件大，恢复慢。

#### (3) RDB + AOF 混合
- **原理**：
  - Redis 4.0+ 支持两者结合。
  - RDB 做全量快照，AOF 记录增量。
- **配置**：
```conf
appendonly yes
save 60 1000
```
- **优点**：
  - 兼顾恢复速度和数据完整性。
- **恢复**：
  - 先加载 RDB，再重放 AOF。

#### (4) 主从复制
- **原理**：
  - 主节点写数据，从节点实时同步。
  - 主故障时，从节点接管。
- **配置**：
```conf
# 从节点配置
replicaof <master_ip> <master_port>
```
- **同步方式**：
  - 全量同步：初次复制 RDB。
  - 增量同步：实时复制命令。
- **优点**：
  - 数据多份备份。
- **缺点**：
  - 主从切换需手动或工具。

#### (5) 高可用架构
- **Sentinel**：
  - 监控主从节点，自动故障转移。
  - 配置：
```conf
sentinel monitor mymaster 127.0.0.1 6379 2
```
- **Redis Cluster**：
  - 分片存储，节点间数据冗余。
  - 配置槽（16384 个）和副本。
- **优点**：
  - 高可用，单点故障不丢数据。

#### (6) 运维策略
- **定期备份**：
  - 定时复制 `.rdb` 或 `.aof` 到远程。
- **监控告警**：
  - 检查内存、磁盘、复制延迟。
- **防误操作**：
  - 设置密码，禁用 `FLUSHALL`。

---

### 3. 数据不丢失的保障程度
| **方法**         | **丢失风险**         | **适用场景**         |
|------------------|----------------------|----------------------|
| RDB             | 快照间隔内数据       | 性能优先，少量丢失可接受 |
| AOF (everysec)  | 最多 1 秒数据        | 平衡性能和可靠性     |
| AOF (always)    | 无丢失               | 数据敏感，性能可牺牲 |
| 主从 + Sentinel | 主从切换间隙         | 高可用性             |
| Cluster         | 极低（多副本）       | 大规模分布式         |

---

### 4. 延伸与面试角度
- **性能权衡**：
  - AOF always：最安全，但 QPS 下降。
  - RDB：快，但丢数据。
- **实际应用**：
  - 电商：AOF + 主从，订单数据不丢。
  - 缓存：仅 RDB，丢数据可重载。
- **优化**：
  - SSD 磁盘：提升持久化速度。
  - 主从延迟：调大缓冲区（`repl-backlog-size`）。
- **面试点**：
  - 问“方法”时，提 RDB 和 AOF。
  - 问“场景”时，提权衡。

---

### 示例
```bash
# 开启 AOF 和 RDB
redis-server --appendonly yes --save 60 1000
# 主从配置
redis-server --replicaof 192.168.1.100 6379
```

---

### 总结
Redis 通过 RDB 快照、AOF 日志、主从复制和高可用架构保证数据不丢失。RDB 适合快速恢复，AOF 保证完整性，结合运维策略实现高可靠性。面试时，可提混合模式或画架构图，展示理解深度。

Redis Cluster 是 Redis 官方提供的分布式解决方案，旨在提供 Redis 数据集的水平扩展能力和高可用性。它允许将数据自动分片到多个 Redis 节点上，并在部分节点出现故障时继续提供服务。

### 1. 核心目标与特性

*   **水平扩展 (Horizontal Scaling)**：Redis Cluster 允许将你的数据自动分片（sharding）到多个 Redis 实例上，从而突破单个 Redis 实例的内存和 CPU 限制，处理更大的数据集和更高的并发量。
*   **高可用性 (High Availability)**：通过主从复制机制，每个分片（sharded part）都可以有一个或多个副本（从节点）。当主节点出现故障时，Redis Cluster 能够自动进行故障转移（failover），将一个从节点提升为新的主节点，从而保证服务的连续性。
*   **去中心化 (Decentralization)**：Cluster 中没有中心代理（proxy）或协调节点。所有的节点都通过 Gossip 协议相互通信，共享集群状态信息，从而避免了单点故障。
*   **性能**：与单机 Redis 实例的性能相近，因为它避免了数据在代理层进行路由的额外开销。

### 2. 工作原理

Redis Cluster 的核心工作原理可以概括为以下几个方面：

#### 2.1 数据分片 (Sharding) - Hash Slots

*   **哈希槽 (Hash Slots)**：Redis Cluster 将整个数据集划分为 16384 个哈希槽（hash slots）。每个键（key）通过 CRC16 算法计算哈希值，然后对 16384 取模，得到它所属的哈希槽。
    `hash_slot = CRC16(key) % 16384`
*   **槽位分配**：集群中的每个主节点负责一部分哈希槽。例如，一个三节点集群，节点 A 可能负责 0-5460 槽，节点 B 负责 5461-10922 槽，节点 C 负责 10923-16383 槽。
*   **键到节点的映射**：当客户端发起请求时，它会知道哪个键属于哪个哈希槽，进而知道哪个节点负责这个哈希槽。

#### 2.2 主从复制与故障转移 (Replication and Failover)

*   **主从结构**：为了提供高可用性，每个主节点都可以拥有一个或多个从节点。从节点会复制主节点的数据。
*   **故障检测**：集群中的所有节点通过心跳包（ping/pong 包）和 Gossip 协议不断地交换信息，检测其他节点的状态。当大多数主节点都认为某个主节点失联（PFAIL -> FAIL 状态）时，就会触发故障转移流程。
*   **选举从节点**：在检测到主节点故障后，其对应的从节点会通过 Raft 协议的简化版本进行领导者选举，其中一个从节点会被提升为新的主节点。
*   **客户端更新**：集群状态更新后，客户端会被通知新的拓扑结构，后续请求会路由到新的主节点。

#### 2.3 客户端重定向 (Client Redirection)

*   **Smart Clients**：Redis Cluster 需要“智能”客户端。客户端首次连接集群时，会获取集群的槽位分配信息（哪个节点负责哪个槽）。
*   **MOVED 重定向**：如果客户端向错误的节点发送了请求（例如，该键所属的槽位不在此节点），服务器会返回一个 `MOVED` 重定向错误，告诉客户端正确的节点 IP 和端口。客户端收到 `MOVED` 错误后，会更新其本地的槽位-节点映射缓存，并向正确的节点重新发送请求。
*   **ASK 重定向**：`ASK` 重定向通常发生在集群进行重新分片（resharding）时。当一个槽位正在从一个节点迁移到另一个节点时，客户端可能会收到 `ASK` 错误。`ASK` 与 `MOVED` 的区别在于，`ASK` 只是临时的重定向，客户端不会更新其槽位映射缓存，只会针对当前请求进行一次重试。

#### 2.4 集群总线 (Cluster Bus) 与 Gossip 协议

*   每个 Redis Cluster 节点都维护两个 TCP 连接：一个用于处理客户端请求，另一个是集群总线端口，用于节点之间的通信。
*   节点之间通过集群总线端口使用 Gossip 协议交换集群状态信息，包括节点的健康状况、槽位配置、故障信息等。这是去中心化架构的基础。

### 3. 使用场景与限制

#### 适用场景：

*   需要处理超过单机 Redis 内存限制的大规模数据集。
*   需要高并发和高吞吐量的场景。
*   对可用性有较高要求，不能接受单点故障。

#### 限制：

*   **多键操作限制**：Redis Cluster 不支持跨多个哈希槽的多键操作（如 `MSET`、`MGET`、`DEL` 等），因为这些键可能分布在不同的节点上。如果需要操作的多个键位于同一个哈希槽，则没有问题。可以通过在键名中使用“哈希标签”（Hash Tags，例如 `{user100}.name` 和 `{user100}.email`，它们都会映射到同一个哈希槽）来强制多个键位于同一个槽。
*   **事务和 Lua 脚本限制**：同样，事务（`MULTI`/`EXEC`）和 Lua 脚本也只能在单个哈希槽内执行。
*   **数据库编号**：Redis Cluster 仅支持一个数据库，即 `DB 0`。
*   **客户端复杂性**：需要使用支持 Redis Cluster 协议的智能客户端。
*   **部署与运维**：相对于单机 Redis 或主从复制，Redis Cluster 的部署、配置和运维会更复杂一些。

### 总结

Redis Cluster 是 Redis 官方为分布式环境提供的高级解决方案，它通过数据分片实现了水平扩展，通过主从复制和自动故障转移提供了高可用性。虽然它对多键操作和事务有一些限制，但对于需要处理大规模数据集和高并发访问的场景来说，它是一个强大而高效的选择。
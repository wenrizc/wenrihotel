
TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。它的连接建立（三次握手）和连接断开（四次挥手）是保证其可靠性的重要机制。

简述TCP三次握手（Three-way Handshake）

三次握手的目的是为了建立一个可靠的TCP连接，确保双方都具备发送和接收数据的能力。

过程如下：
。
1.  第一次握手（SYN）：
    *   客户端（发起方）向服务器（接收方）发送一个SYN（Synchronize Sequence Numbers，同步序列编号）报文段。
    *   这个报文段中，SYN标志位被置为1，同时客户端会选择一个初始序列号 `client_isn` (Initial Sequence Number)。
    *   客户端进入 `SYN_SENT` 状态，等待服务器确认。

2.  第二次握手（SYN-ACK）：
    *   服务器收到客户端的SYN报文段后，如果同意建立连接，会向客户端发送一个确认报文段。
    *   这个报文段中，SYN标志位和ACK（Acknowledgement，确认）标志位都被置为1。
    *   服务器会选择自己的初始序列号 `server_isn`。
    *   确认号 `ack` 设置为 `client_isn + 1`，表示对客户端的SYN的确认。
    *   服务器进入 `SYN_RCVD` 状态。

3.  第三次握手（ACK）：
    *   客户端收到服务器的SYN-ACK报文段后，会向服务器发送一个确认报文段。
    *   这个报文段中，ACK标志位置为1。
    *   序列号 `seq` 设置为 `client_isn + 1`。
    *   确认号 `ack` 设置为 `server_isn + 1`，表示对服务器的SYN的确认。
    *   此报文段发送完毕后，客户端和服务器都进入 `ESTABLISHED` 状态，TCP连接建立成功，双方可以开始传输数据。

简述TCP四次挥手（Four-way Handshake）

四次挥手的目的是为了优雅地终止TCP连接，确保双方数据都传输完毕。

过程如下：

1.  第一次挥手（FIN）：
    *   客户端（或服务器，假设是客户端先发起关闭）决定关闭连接，向服务器发送一个FIN（Finish，结束）报文段。
    *   FIN标志位置为1，并包含一个序列号 `seq = u`。
    *   客户端进入 `FIN_WAIT_1` 状态。此时客户端不能再发送数据，但仍能接收数据。

2.  第二次挥手（ACK）：
    *   服务器收到客户端的FIN报文段后，向客户端发送一个ACK报文段作为确认。
    *   ACK标志位置为1，确认号 `ack = u + 1`，序列号 `seq = v`。
    *   服务器进入 `CLOSE_WAIT` 状态。此时服务器可能还有数据要发送给客户端，所以连接并未立即关闭。客户端收到ACK后进入 `FIN_WAIT_2` 状态。

3.  第三次挥手（FIN）：
    *   服务器完成所有数据发送后，向客户端发送一个FIN报文段。
    *   FIN标志位置为1，ACK标志位置为1（因为可能捎带对之前数据的确认），确认号 `ack = u + 1`（与第二次挥手相同，如果中间没有数据交互则不变），序列号 `seq = w`（如果服务器在`CLOSE_WAIT`期间发送了数据，w会是v加上发送数据的长度；否则w可能等于v）。
    *   服务器进入 `LAST_ACK` 状态，等待客户端的最后确认。

4.  第四次挥手（ACK）：
    *   客户端收到服务器的FIN报文段后，向服务器发送一个ACK报文段作为确认。
    *   ACK标志位置为1，确认号 `ack = w + 1`，序列号 `seq = u + 1`。
    *   客户端进入 `TIME_WAIT` 状态。等待2MSL（Maximum Segment Lifetime，最大报文段生存时间）后，连接彻底关闭，客户端进入 `CLOSED` 状态。
    *   服务器收到客户端的ACK后，连接关闭，进入 `CLOSED` 状态。


为什么握手是三次？

三次握手是建立可靠连接所需的最小次数。

*   第一次握手：客户端向服务器表明“我想和你建立连接，我的初始序列号是X”。服务器知道了客户端有发送能力。
*   第二次握手：服务器向客户端表明“我收到了你的请求，同意建立连接，我的初始序列号是Y，同时我确认了你的序列号X+1”。客户端知道了服务器有接收和发送能力，并且自己的请求被对方确认了。
*   第三次握手：客户端向服务器表明“我收到了你的确认和你的初始序列号Y，我确认你的序列号Y+1”。服务器知道了客户端有接收能力，并且自己的请求也被对方确认了。

至此，双方都确认了对方的发送和接收能力，并且双方都同步了初始序列号。

*   如果只有两次握手：
    假设客户端发送SYN，服务器回复SYN-ACK。此时服务器认为连接已建立，但如果服务器的SYN-ACK丢失，客户端会超时重传SYN。如果服务器的SYN-ACK没有丢失，客户端收到后也不再回复，那么服务器无法确认客户端是否收到了自己的SYN-ACK，即无法确认客户端是否准备好接收数据。
    更重要的是，考虑“已失效的连接请求报文段”问题：客户端发送了一个SYN，但因网络原因滞留，超时后客户端重发了新的SYN并成功建立连接、传输数据、关闭连接。此时，那个滞留的旧SYN到达了服务器，服务器会误以为是新的连接请求，发送SYN-ACK。如果只有两次握手，服务器就会单方面建立连接并等待数据，浪费资源。三次握手时，客户端收到这个旧连接的SYN-ACK后，其状态不是`SYN_SENT`，会发送RST报文终止这个错误的连接。

为什么挥手是四次？

TCP是全双工通信，这意味着连接的关闭需要双方各自独立地关闭其发送通道。

*   第一次挥手（客户端FIN）：客户端告诉服务器：“我没有数据要发送给你了，但我还能接收你发来的数据。”
*   第二次挥手（服务器ACK）：服务器告诉客户端：“我知道你没有数据要发了。” 此时，服务器可能还有数据没有发送完毕，所以不能立即关闭自己的发送通道（即不能立即发送FIN）。服务器需要时间处理和发送剩余数据。
*   第三次挥手（服务器FIN）：服务器告诉客户端：“我的数据也发送完毕了，现在我可以关闭连接了。”
*   第四次挥手（客户端ACK）：客户端告诉服务器：“我知道你可以关闭连接了。” 服务器收到这个ACK后就关闭连接。客户端则进入`TIME_WAIT`状态，确保服务器收到了这个最后的ACK。

核心区别在于：
*   握手时，服务器的SYN和ACK可以合并在一个报文段（SYN-ACK）中发送，因为服务器在确认客户端的SYN后，通常也立即准备好发送自己的SYN。
*   挥手时，当一方（如客户端）发送FIN表示数据发送完毕，接收方（服务器）通常需要先回复一个ACK表示收到，然后可能还需要继续发送未完成的数据。只有当接收方也确认所有数据都发送完毕后，它才会发送自己的FIN。这两个动作（ACK确认对方的FIN 和 自己发送FIN）之间可能存在时间差和数据传输，因此通常需要分成两个独立的报文段。

所以，挥手之所以是四次，主要是因为TCP的半关闭（Half-close）特性，允许一方终止发送，但仍能接收数据，直到另一方也终止发送。

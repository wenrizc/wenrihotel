
### MVCC是什么

MVCC，全称为Multi-Version Concurrency Control，即多版本并发控制。

它是一种并发控制的方法，核心思想是“以空间换时间”，通过保存数据在某个时间点的多个版本，来实现读写操作的并发执行，从而避免了传统的读写锁所带来的性能开销。

简单来说，它的目标就是让读操作不再阻塞写操作，同时写操作也不阻塞读操作。当一个事务在读取数据时，另一个事务可以同时修改这份数据，读取的事务会看到修改前的数据版本，从而保证了数据的一致性。

### MVCC是如何实现的

在MySQL的InnoDB引擎中，MVCC的实现并不是一个单一的组件，而是由以下三个核心部分协同工作完成的：

1.  行记录中的隐藏字段
2.  Undo Log（撤销日志）
3.  ReadView（读视图）

下面我将逐一解释它们的作用：

#### 1. 行记录中的隐藏字段

InnoDB会为表中的每一行记录，额外增加几个隐藏的系统字段，其中与MVCC最相关的有两个：

*   DB_TRX_ID (6字节): 记录了最近一次创建或修改该行记录的事务ID。
*   DB_ROLL_PTR (7字节): 这是一个回滚指针，它指向该行记录上一个版本在Undo Log中的位置。

这两个字段串联起了数据行的历史版本链。

#### 2. Undo Log

Undo Log是MVCC实现版本控制的关键。当事务需要修改数据时，它不会直接覆盖原始数据，而是会执行以下操作：

1.  将原始的行记录数据复制一份，存放到Undo Log中。
2.  修改原始行记录的数据。
3.  将被修改行的DB_TRX_ID更新为当前事务的ID。
4.  将被修改行的DB_ROLL_PTR指向刚刚在Undo Log中创建的那个旧版本记录。

这样，通过DB_ROLL_PTR，一个行记录的所有历史版本就形成了一个单向链表，我们称之为“版本链”。链头是当前最新的数据，链尾是最早的数据。Undo Log除了用于MVCC，也用于事务的回滚。

#### 3. ReadView（读视图）

ReadView是MVCC实现“一致性快照”的核心，它决定了一个事务在执行时能“看到”哪些版本的数据。

当一个事务开始执行SELECT操作时，InnoDB会为它创建一个ReadView。这个ReadView主要包含以下几个关键信息，它记录了在创建ReadView那一刻，系统中所有活跃（未提交）的事务ID列表：

*   m_ids: 一个列表，包含了创建ReadView时，所有活跃事务的ID。
*   min_trx_id: m_ids列表中的最小事务ID。
*   max_trx_id: 系统下一个将要分配的事务ID，即创建ReadView时系统中已出现的最大事务ID + 1。
*   creator_trx_id: 创建这个ReadView的事务本身的ID。

#### MVCC的读操作流程

当一个事务（我们称之为事务A）要去读取某一行数据时，它会拿着自己的ReadView，按照以下规则来判断当前行记录的版本是否对它可见：

1.  首先比较行记录的DB_TRX_ID与ReadView中的creator_trx_id。如果两者相同，说明是本事务自己修改的，那么这个版本可见。
2.  如果DB_TRX_ID小于ReadView中的min_trx_id，说明修改该行的事务在事务A创建ReadView之前就已经提交了，那么这个版本可见。
3.  如果DB_TRX_ID大于或等于ReadView中的max_trx_id，说明修改该行的事务是在事务A创建ReadView之后才开启的，那么这个版本不可见。
4.  如果DB_TRX_ID在min_trx_id和max_trx_id之间，那么就需要检查DB_TRX_ID是否存在于ReadView的m_ids列表中。如果存在，说明修改该行的事务在创建ReadView时还是活跃的，那么这个版本不可见。如果不存在，说明它已经提交了，那么这个版本可见。

如果当前版本对事务A不可见，它就会顺着DB_ROLL_PTR指向的Undo Log链，去查找上一个版本，然后对上一个版本的数据重复进行上述的可见性判断，直到找到一个可见的版本为止。

### MVCC与隔离级别的关系

ReadView的创建时机，直接决定了不同的隔离级别：

*   在读已提交（Read Committed）隔离级别下，每一次执行SELECT语句都会重新创建一个ReadView。这就是为什么在该级别下，一个事务内两次相同的查询可能会读到不同数据（不可重复读）。
*   在可重复读（Repeatable Read）隔离级别下，只有在事务中的第一次SELECT语句执行时才会创建一个ReadView，并且在整个事务期间都复用这一个ReadView。因为快照没有变，所以每次查询看到的数据版本都是一致的，从而实现了可重复读。

总而言之，MVCC通过“隐藏字段 + Undo Log + ReadView”这一套组合拳，实现了在不加锁或少加锁的情况下处理读写冲突，极大地提升了数据库的并发性能。
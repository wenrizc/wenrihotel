
AOP（面向切面编程）的核心思想是将那些与核心业务无关，但又散布在多个业务模块中的“横切关注点”（如日志、事务、安全等）分离出来，形成一个独立的“切面”（Aspect）。然后通过某种方式，将这些切面逻辑动态地插入到业务代码的特定位置，这个插入的过程就叫做“织入”（Weaving）。

AOP的实现方式，主要区别就在于“织入”这个动作发生的时机。根据时机的不同，可以分为三大类：静态织入、加载期织入和运行时织入。

### 1. 静态织入 (Static Weaving)

静态织入发生在代码的编译期。它直接修改编译好的字节码文件（.class文件），或者在编译时就将切面代码和业务代码编译到一起，生成一个包含了切面逻辑的新的字节码文件。

- 实现方式：最典型的代表就是 AspectJ。AspectJ有一个专门的编译器叫 ajc。在编译时，ajc 会找到所有的切点（Pointcut），然后把通知（Advice）逻辑直接以字节码指令的形式，插入到目标方法的相应位置。
    
- 优点：
    
    - 性能最高：因为织入操作在编译期就已完成，运行时执行的就是一个已经包含了切面逻辑的普通方法，几乎没有额外的性能开销，执行效率和直接调用一样。
        
    - 功能最强：可以对几乎所有的连接点（Join Point）进行织入，包括方法调用、方法执行、字段访问、构造函数调用等，能力非常全面。
        
- 缺点：
    
    - 侵入性强，不灵活：需要在编译流程中引入特殊的编译器（ajc），或者在编译后增加一个字节码增强的步骤，使得构建过程变复杂。
        
    - 维护困难：一旦切面逻辑需要修改，所有相关的业务代码都需要重新编译。
        

### 2. 加载期织入 (Load-Time Weaving, LTW)

加载期织入是一个折中的方案，它的织入时机发生在JVM加载类文件的时候。

- 实现方式：它利用了Java的Agent技术。在启动JVM时，通过添加 -javaagent 参数来指定一个织入代理。当JVM的类加载器（ClassLoader）加载一个类的字节码时，这个代理会先拦截到这个字节码流，然后进行动态修改，将切面逻辑织入进去，最后再把修改后的字节码交给JVM。AspectJ也支持这种方式。
    
- 优点：
    
    - 无需修改编译过程：开发者可以像平常一样编译代码，织入操作对开发过程是透明的。
        
    - 灵活性较高：可以在不重新编译代码的情况下，通过修改代理配置来开启或关闭某些切面。
        
- 缺点：
    
    - 应用启动变慢：因为在类加载时需要进行额外的织入操作，会增加应用的启动时间。
        
    - 配置相对复杂：需要在启动脚本中配置javaagent，并且可能需要管理一个aop.xml这样的配置文件。
        

### 3. 运行时织入 (Runtime Weaving)

运行时织入是目前应用最广泛的方式，它在程序运行期间动态地创建代理对象来实现AOP。我们最熟悉的 Spring AOP 就是采用这种方式。

Spring AOP并不会去修改原始类的字节码，而是在运行时，当一个Bean需要被AOP增强时，Spring容器会为这个Bean动态地创建一个代理对象。客户端代码调用的不再是原始对象，而是这个代理对象。代理对象内部封装了切面逻辑，并在调用原始对象方法的前后执行这些逻辑。

Spring AOP主要通过两种技术来创建代理对象：

- JDK动态代理 (JDK Dynamic Proxy)：
    
    - 实现原理：这是Java官方提供的代理技术，位于java.lang.reflect.Proxy。它要求目标类必须实现至少一个接口。在运行时，它会动态地创建一个实现了相同接口的代理类。所有对接口方法的调用都会被转发到一个统一的 InvocationHandler 处理器，我们可以在这个处理器中加入切面逻辑，并最终通过反射调用真实目标对象的方法。
        
    - 限制：只能代理接口，无法代理没有实现接口的普通类。
        
- CGLIB (Code Generation Library)：
    
    - 实现原理：这是一个第三方的代码生成库。当目标类没有实现接口时，Spring AOP会使用CGLIB。它通过在运行时动态地创建一个目标类的子类来作为代理。它会重写父类中所有非final的方法，在重写的方法中织入切面逻辑，并通过调用 super.method() 来执行原始的业务逻辑。
        
    - 优点：可以代理没有实现接口的类，弥补了JDK动态代理的不足。
        
- 运行时织入的优缺点：
    
    - 优点：
        
        - 无侵入性：完全不需要特殊的编译器或代理，对开发和构建过程没有任何影响，使用最为简单。
            
        - 与Spring容器无缝集成：可以方便地对Spring管理的Bean进行增强。
            
    - 缺点：
        
        - 性能相对最低：因为涉及到动态创建代理对象和方法拦截，其性能相比静态织入有一定损耗。
            
        - 功能受限：Spring AOP是基于方法拦截的，所以它只能对方法的执行进行增强，无法像AspectJ那样对字段访问、构造函数等进行织入。同时，由于代理机制的限制，类中的 final 或 private 方法也无法被代理。
            

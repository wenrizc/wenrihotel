
在MyBatis中，`#` 和 `$` 是用于在SQL语句中动态替换参数的两种主要方式，但它们之间存在着本质的区别，主要体现在SQL处理方式和安全性上。

### 核心区别

| 特性 | `#{}` (占位符) | `${}` (字符串替换) |
| --- | --- | --- |
| **处理方式** | 预编译处理 (PreparedStatement) | 字符串直接拼接 |
| **SQL注入** | **能有效防止SQL注入** | **存在SQL注入风险** |
| **参数处理** | 将传入的参数作为一个值，并根据参数类型自动加上引号（例如字符串会加上 ' '）。 | 直接将传入的参数拼接到SQL语句中，不会添加任何额外的引号。 |
| **使用场景** | 适用于传递绝大多数业务参数，如`WHERE`条件值、`INSERT`和`UPDATE`的字段值等。 | 适用于动态修改SQL的结构，例如动态指定表名、列名或排序规则 (`ORDER BY`)。 |

---

### 详细解析与示例

#### `#{}` (预编译)

`#{}` 在MyBatis中会被解析为一个JDBC预编译语句（PreparedStatement）的参数标记符 `?`。

**工作原理：**
1.  MyBatis会先将包含 `#{}` 的SQL语句进行预编译，生成一个执行计划。
2.  然后，将 `#{}` 所引用的参数值安全地设置到预编译语句中。
3.  数据库驱动在执行时会正确处理参数的类型和转义，从而有效防止SQL注入攻击。

**示例：**
假设我们有以下MyBatis查询：

```xml
<select id="getUserById" resultType="com.example.User">
  SELECT * FROM users WHERE id = #{userId}
</select>
```

如果传入的 `userId` 是 `123`，最终执行的SQL在数据库层面大致如下：

```sql
-- 预编译的SQL
SELECT * FROM users WHERE id = ?

-- 设置参数
(userId = 123)
```

如果一个恶意用户尝试传入 `123 OR 1=1`，`#{}` 会将其整个作为一个字符串值来处理，生成的SQL会是：

```sql
SELECT * FROM users WHERE id = '123 OR 1=1'
```
这不会导致SQL注入，因为数据库会寻找ID为“123 OR 1=1”的记录，而不是执行`OR 1=1`这个逻辑。

#### `${}` (字符串替换)

`${}` 则会直接将参数值作为字符串拼接到SQL语句中。

**工作原理：**
MyBatis在处理SQL时，会简单地将 `${}` 替换为传入的参数字符串，然后才将完整的SQL语句交给数据库执行。 这种方式不会进行预编译。

**示例：**
继续使用上面的例子，但换成 `${}`：

```xml
<select id="getUserById" resultType="com.example.User">
  SELECT * FROM users WHERE id = ${userId}
</select>
```

如果传入的 `userId` 是 `123`，拼接后的SQL为：

```sql
SELECT * FROM users WHERE id = 123
```

**SQL注入风险：**
如果恶意用户传入 `123 OR 1=1`，拼接后的SQL将变为：

```sql
SELECT * FROM users WHERE id = 123 OR 1=1
```
这将导致所有用户的数据被查询出来，造成严重的安全漏洞。

#### `${}` 的合理使用场景

尽管存在安全风险，但在某些特定场景下 `${}` 是必需的。这些场景通常涉及动态SQL结构，而不是传递参数值。

**示例：动态排序**
假设需要根据用户指定的列进行排序。

```xml
<select id="getUsers" resultType="com.example.User">
  SELECT * FROM users ORDER BY ${columnName} ${sortDirection}
</select>
```

在这里，`#{}` 是无法工作的，因为它会将列名视为一个字符串，导致SQL语法错误（例如 `ORDER BY 'name'`）。

**重要提示：** 当使用 `${}` 并且其值来源于用户输入时，**必须**在应用层进行严格的白名单校验，以确保传入的只是预期的、安全的值（例如，检查 `columnName` 是否是合法的数据库列名），从而避免SQL注入。

### 总结

*   **优先使用 `#{}`**：在所有传递参数值的地方，都应该优先使用 `#{}`。这是最安全、最推荐的方式。
*   **谨慎使用 `${}`**：只在需要动态修改SQL结构（如表名、列名、排序规则）时才使用 `${}`。
*   **安全第一**：当必须使用 `${}` 时，切记要对参数进行严格的校验和过滤，以防止SQL注入攻击。

## 1. 登录用户购物车

登录用户的购物车信息会永久保存在数据库中，确保用户可以随时访问和管理自己的购物车。

### 核心设计思路

- **购物车主体与购物车项分离**：购物车主表记录用户信息和购物车状态，购物车项表记录具体商品信息
- **状态管理机制**：购物车有明确的状态标识（正常、已下单、已过期）
- **懒创建策略**：仅当用户首次添加商品时才创建购物车记录

### 数据存储结构

- **购物车主表**：存储用户ID、创建时间、更新时间和状态
- **购物车项表**：存储商品详细信息（ID、名称、图片）、规格信息、价格、数量、是否选中等

### 业务流程

1. **购物车查询**：登录后自动查询用户最近一个活跃购物车
2. **添加商品**：
    - 检查用户是否有活跃购物车，没有则创建新购物车
    - 验证商品状态和库存
    - 检查购物车是否已存在该商品，存在则叠加数量，否则新增记录
3. **更新商品**：验证商品状态和库存后更新数量或选中状态
4. **删除商品**：从购物车项表中删除记录
5. **购物车结算**：
    - 验证选中商品的有效性
    - 创建订单
    - 将购物车标记为已下单状态
    - 清空已结算的购物车项

## 2. 购物车商品验证

购物车中的商品需要进行实时验证，确保结算时商品状态和库存信息有效。

### 验证时机

- **添加商品时**：验证商品是否存在、是否上架、库存是否充足
- **更新数量时**：验证增加后的数量是否超过库存
- **结算前**：再次全面验证所有选中商品

### 验证内容

- **商品基本状态**：商品是否存在、是否已下架
- **库存检查**：当前库存是否满足购买数量
- **价格验证**：确保价格与当前最新价格一致

### 处理策略

- **无效商品处理**：结算时发现无效商品会提示用户，无法继续结算
- **库存不足处理**：允许保留在购物车，但结算时会提醒用户调整数量

## 3. 扩展功能

### 购物车操作日志

记录用户对购物车的各种操作（添加、修改数量、删除等），便于后续分析用户行为和问题排查。

### 促销活动关联

购物车可以关联各类促销活动，如满减、满折、直减等，并计算优惠金额。

### 直接购买

支持"立即购买"功能，用户可以跳过添加购物车步骤，直接进入结算流程。

### 商品分组展示

按店铺对购物车商品进行分组展示，提升用户体验。

## 4. 数据一致性保障

- **事务管理**：购物车关键操作使用事务保证数据一致性
- **乐观锁机制**：防止并发操作导致数据异常
- **定时任务**：定期检查和清理异常数据，如长时间未更新的购物车
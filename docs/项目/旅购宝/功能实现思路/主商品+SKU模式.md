
## 一、主商品+SKU模式概念

主商品+SKU模式是电商系统中常用的商品管理架构，它将商品信息分为两个层次：

- **主商品(SPU)**：Standard Product Unit，标准化产品单位，代表一类商品的集合
- **SKU**：Stock Keeping Unit，库存管理单位，代表具体可售卖的商品规格组合

这种模式就像是一个"商品家族"的概念，主商品是家族名称，SKU是家族中的每个成员。

## 二、数据模型设计思路

### 1. 主商品(Product)设计

- 存储商品的通用信息：名称、描述、分类、封面图、图片集、状态等
- 维护与分类的关联关系
- 记录商品的基础销量和评分数据
- 存储最低价格(通常从所有SKU中选取最低价)

### 2. 商品规格(ProductSku)设计

- 与主商品建立一对多关系
- 存储规格组合信息：如颜色、尺寸、容量等
- 维护独立的价格体系
- 记录独立的库存数据：总库存、锁定库存
- 统计规格级别的销量数据

## 三、业务流程实现思路

### 1. 商品分类管理

- 支持多级分类树形结构
- 主商品通过categoryId关联到分类
- 在查询展示时可按分类筛选和聚合商品

### 2. 商品基本信息管理

- 主商品实体承载基础属性
- 通过ProductService提供商品信息维护
- 支持商品搜索、推荐、排序等功能
- 利用ElasticSearch实现商品高效检索

### 3. 商品规格(SKU)管理

- 每个主商品关联多个规格组合
- 规格值使用specsValues字段存储规格组合描述
- 不同规格组合具有独立价格
- 通过ProductSkuService管理SKU的CRUD操作

### 4. 商品库存管理

系统采用"预锁定+确认扣减"模式:

- **库存设计**：每个SKU包含总库存(stock)和锁定库存(stockLocked)
- **库存锁定**：下单时锁定库存(增加stockLocked)，但不减少总库存
- **库存确认**：支付成功后实际扣减库存(减少stock并减少stockLocked)
- **库存释放**：订单取消时解锁库存(减少stockLocked)

### 5. 商品上下架管理

- 通过Product表中的status字段控制(0-下架，1-上架)
- 支持按状态查询和筛选商品
- 上架商品才能被展示、搜索和购买
- 在购买流程中验证商品上架状态

## 四、策略模式应用

系统使用策略模式处理不同类型商品，提高扩展性：

- ProductTypeHandler接口定义商品处理策略
- 不同实现类处理不同商品类型：普通商品、门票、优惠券等
- 通过ProductTypeHandlerFactory注册和获取不同商品类型的处理策略
- 各处理策略实现商品验证、库存操作、订单处理等功能

## 五、主商品+SKU模式的优势

1. **信息管理高效**：避免规格信息冗余，减少数据维护成本
2. **灵活的价格体系**：不同规格可设置不同价格
3. **精确的库存控制**：库存精确到SKU级别
4. **优化用户体验**：用户可以方便地在同一页面比较不同规格
5. **降低运营成本**：添加新规格不需要创建新商品
6. **数据结构清晰**：便于统计分析和数据处理

## 六、为什么当前项目采用此模式

1. **业务场景复杂**：系统需要处理普通商品、门票和优惠券等多种类型商品
2. **多规格需求**：商品具有多样化的规格组合选择
3. **库存精细化管理**：需要实现预锁定等精确库存控制机制
4. **交易流程完整**：支持购物车、下单、支付等完整流程
5. **扩展性考虑**：便于后续增加新的商品类型和处理逻辑

## 七、其他商品管理模式

除了当前项目使用的主商品+SKU模式外，还存在其他几种商品管理模式：

### 1. 扁平化模式

每个规格组合都作为一个独立商品记录，不区分主商品和SKU。

商品表:

ID: 1, 名称: "iPhone 14 Pro 128GB 黑色", 价格: 7999, 库存: 100

ID: 2, 名称: "iPhone 14 Pro 256GB 黑色", 价格: 8999, 库存: 80

ID: 3, 名称: "iPhone 14 Pro 128GB 银色", 价格: 7999, 库存: 90

### 2. 属性组合模式

商品具有基础信息和动态属性字段，通过属性组合计算价格和库存。

商品表: ID: 1, 名称: "iPhone 14 Pro"

属性表: {颜色: ["黑色", "银色"], 容量: ["128GB", "256GB"]}

价格规则表: {基础价: 7999, 256GB: +1000}

### 3. BOM模式（物料清单）

适用于组合商品，如套餐或礼盒，一个主商品包含多个子商品项。

套餐商品: ID: 1, 名称: "手机套装"

子商品关系: [{商品ID: 10, 名称: "手机", 数量: 1}, {商品ID: 20, 名称: "保护壳", 数量: 1}]

### 4. 动态价格模式

商品基本信息固定，价格根据市场、会员等级、时间等实时计算。
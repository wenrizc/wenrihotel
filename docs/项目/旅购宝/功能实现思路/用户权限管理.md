
## 一、现状分析

目前HMDP项目的权限管理存在明显不足：

1. **包结构区分但缺乏实际权限检查**：
    
    - 控制器按用户角色分为[controller.user]、[controller.merchant]、[controller.admin]包
    - 缺乏实际的权限校验机制，仅依赖URL路径区分
2. **简单的拦截器**：
    
    - [LoginInterceptor]只检查用户是否登录，不检查权限
    - [RefreshTokenInterceptor]处理Token刷新，不涉及权限控制
3. **用户模型缺陷**：
    
    - [User]实体类中没有角色字段，无法区分用户类型
    - JWT令牌中不包含权限信息
4. **安全隐患**：
    
    - 任何登录用户都能访问任何接口，包括商家和管理员功能
    - 缺少基于角色的访问控制(RBAC)机制

## 二、权限管理实现思路

### 1. 用户角色模型设计

#### 1.1 角色定义

明确定义三种角色类型：

- **普通用户(USER)**：享有基本功能，如浏览商品、下单、评价等
- **商家(MERCHANT)**：可管理自己的店铺、发布商品和优惠券等
- **系统管理员(ADMIN)**：可管理全平台内容，访问系统监控等

#### 1.2 数据库设计

修改用户表结构：

tb_user表:

- 增加role字段(INT)：0-普通用户，1-商家，2-管理员

扩展用户-商铺关联表：

tb_shop_owner表:

- id：主键

- user_id：用户ID

- shop_id：商铺ID

- create_time：创建时间

- update_time：更新时间

### 2. JWT令牌改进

在JWT令牌中添加角色信息：

- **载荷(Payload)设计**：
    - userId：用户ID
    - nickName：用户昵称
    - role：用户角色
    - shopId：商家关联的店铺ID（商家角色特有）

### 3. 权限控制拦截器体系

#### 3.1 拦截器层次设计

构建三层拦截器体系：

1. **TokenInterceptor**：令牌解析和用户信息提取（最高优先级）
2. **LoginInterceptor**：登录状态检查（中等优先级）
3. **RoleAuthorizationInterceptor**：角色权限检查（最低优先级）

#### 3.2 角色权限拦截器实现思路

角色权限拦截器应完成以下功能：

- 解析请求路径，判断所需权限级别
- 获取当前用户角色
- 比对权限级别与用户角色
- 如权限不足则拒绝请求，返回403状态码

#### 3.3 URL路径权限映射规则

建立清晰的URL路径与权限级别映射：

- `/user/**`：所有登录用户可访问
- `/merchant/**`、`/shopManage/**`：商家和管理员可访问
- `/admin/**`、`/system/**`：仅管理员可访问

### 4. 商家特殊权限处理

商家只能管理自己的店铺，不能操作其他商家的店铺：

1. **店铺所有权验证**：
    
    - 请求包含shopId时，检查shopId是否属于当前商家
    - 设计商家店铺验证服务，在商家操作前校验所有权
2. **商家功能访问控制**：
    
    - `/shopManage/{shopId}` 路径增加验证
    - `/voucher/shop/{shopId}` 路径增加验证

### 5. 管理员功能实现

1. **分级管理员制度**：
    
    - 考虑实现超级管理员和普通管理员分级（role=2和role=3）
    - 超级管理员拥有用户管理权限
2. **管理功能路径设计**：
    
    - `/admin/users`：用户管理
    - `/system/status`：系统监控
    - `/admin/shops`：店铺管理

### 6. 前端适配

1. **权限信息获取**：
    
    - 登录成功后，前端存储用户角色信息
    - 前端根据角色显示或隐藏功能菜单
2. **权限错误处理**：
    
    - 捕获403权限错误，显示友好提示
    - 提供返回安全区域的引导

### 7. 动态权限配置

为提高系统灵活性，考虑实现动态权限配置：

1. **权限配置表**：
    
    tb_permission表:
    
    - id：主键
    
    - name：权限名称
    
    - url_pattern：URL匹配模式
    
    - required_role：所需角色
    
    - description：描述
    
2. **权限缓存机制**：
    
    - 使用Redis缓存权限配置
    - 管理界面修改权限后实时更新缓存

### 8. 登录注册流程改进

1. **用户注册时默认为普通用户**：
    
    user.setRole(0); // 普通用户
    
2. **商家角色申请流程**：
    
    - 用户提交店铺信息申请成为商家
    - 管理员审核通过后，修改用户角色为商家
    - 建立用户与店铺的关联关系
3. **管理员指定**：
    
    - 管理员通过后台指定其他用户为管理员

### 9. 安全防护措施

1. **接口幂等性保护**：
    
    - 敏感操作添加操作令牌
    - 防止权限提升接口被重放攻击
2. **操作日志记录**：
    
    - 管理员操作记录完整日志
    - 包括操作类型、时间、操作人、影响对象等
3. **权限变更审计**：
    
    - 记录用户角色变更历史
    - 角色变更需要高级管理员批准

通过以上设计，HMDP项目将形成一个完善的多级权限管理体系，能够准确控制不同用户对不同功能的访问权限，保障系统安全性和业务合规性。
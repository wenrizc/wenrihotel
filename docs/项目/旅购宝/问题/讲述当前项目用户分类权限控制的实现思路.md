
## 一、权限体系设计

### 1. 分级角色设计

项目采用了一套分层级的权限控制系统，通过角色划分实现不同用户的权限差异化。系统中主要定义了三个角色等级：

- **普通用户**：权限值为0或null（默认角色）
  - 可以浏览商铺、点评、优惠券等公开信息
  - 可以进行个人操作如下单、使用优惠券等

- **商家用户**：权限值为1
  - 拥有普通用户的所有权限
  - 可以管理自己的商铺信息
  - 可以发布和管理优惠券
  - 可以回复用户评论

- **管理员用户**：权限值大于等于2
  - 拥有系统内最高权限
  - 可以管理任何商铺信息
  - 可以管理所有用户的权限
  - 可以进行系统配置和管理

### 2. 资源访问控制设计

系统根据URL请求路径前缀进行权限区分：

- `/user/*`、`/shop/*`、`/voucher/*` 等路径：大部分开放给所有已登录用户
- `/merchant/*`、`/shopManage/*` 路径：限制商家及以上权限用户访问
- `/admin/*`、`/system/*` 路径：仅限管理员访问

对于特殊路径如 `/shopManage/{shopId}/*`，还会额外验证商家是否为该商铺的实际所有者。

## 二、权限控制实现机制

### 1. 多层拦截器链设计

项目采用Spring MVC的拦截器机制，构建了一个三层拦截器链来处理权限问题：

- **第一层：Token解析拦截器**（优先级最高）
  - 从请求头或cookie中获取token
  - 解析token获取用户信息
  - 将用户信息存入ThreadLocal，方便后续使用
  - 对于有效token，刷新其过期时间

- **第二层：登录拦截器**（中等优先级）
  - 检查ThreadLocal中是否有用户信息
  - 对于未登录用户，拦截受限资源访问
  - 放行公开接口，如登录、注册等

- **第三层：角色权限拦截器**（最低优先级）
  - 检查用户的角色级别是否满足当前请求的权限要求
  - 对于商铺管理接口，验证商铺所有权
  - 拦截越权访问

这种多层设计确保了权限控制的完整性和灵活性，允许系统分阶段处理身份识别、登录状态和权限级别。

### 2. 商铺所有权验证机制

针对商家用户的特殊性，系统实现了商铺所有权验证机制：

- 通过正则表达式从URL中提取商铺ID
- 查询用户与商铺的关联关系
- 管理员可以操作任何商铺
- 商家用户只能操作自己拥有的商铺
- 非商铺所有者的访问会被直接拒绝并记录日志

### 3. ThreadLocal用户上下文

系统使用ThreadLocal机制在请求上下文中存储当前用户信息：

- Token解析后的用户信息存入ThreadLocal
- 后续拦截器和业务逻辑可以直接从ThreadLocal获取用户信息
- 请求结束时自动清理ThreadLocal，避免内存泄漏
- 这种设计避免了在方法间频繁传递用户参数

## 三、用户角色及权限管理

### 1. 角色提升控制

系统对角色提升有严格的控制：

- 只有管理员可以提升其他用户为管理员
- 用户不能修改比自己权限级别高的用户
- 用户不能将他人提升至比自己更高的权限级别
- 所有权限变更操作都会被记录日志

### 2. 商铺分配管理

针对商家用户，系统实现了商铺所有权的分配管理：

- 管理员可以为商家分配或移除商铺
- 一个商铺可以有多个商家管理
- 一个商家可以管理多个商铺
- 商铺所有权变更会触发缓存更新

## 四、安全机制

### 1. JWT令牌与登出机制

系统使用JWT实现用户认证：

- 用户登录成功后获得JWT令牌
- 令牌包含用户ID、角色等信息
- 由于JWT的无状态特性，系统实现了黑名单机制处理用户登出
- 登出时将令牌加入Redis黑名单，并设置与JWT剩余有效期相同的过期时间
- 每次请求都会检查令牌是否在黑名单中

### 2. 防越权保护

系统实现了多层防越权保护：

- URL级别权限控制
- 资源所有权验证
- 操作日志记录
- 敏感操作前的权限再次验证

### 3. 错误处理与日志

- 权限校验失败会返回标准化的错误响应
- 越权尝试会被记录在系统日志中
- 异常处理机制可以捕获并处理权限相关异常

## 总结

项目的用户分类权限控制采用了分层设计思路，通过角色划分、拦截器链、商铺所有权验证等机制，实现了细粒度的权限管理。系统使用ThreadLocal存储用户上下文，JWT实现身份认证，并通过黑名单机制处理登出逻辑。这种设计既保证了系统安全性，又实现了权限控制与业务逻辑的解耦，提高了代码的可维护性和扩展性。
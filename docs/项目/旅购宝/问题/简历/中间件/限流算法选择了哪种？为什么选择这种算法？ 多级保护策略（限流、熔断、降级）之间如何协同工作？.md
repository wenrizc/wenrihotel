

## 限流算法选择

### 1. 主要限流算法

系统在Sentinel中主要采用了漏桶算法（Leaky Bucket）和令牌桶算法（Token Bucket）的结合策略：

- **秒杀接口**：采用**预热型令牌桶算法**
  ```
  seckillRule.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_WARM_UP);
  seckillRule.setWarmUpPeriodSec(10);
  ```

- **普通商品查询**：使用**默认限流策略**（直接拒绝）
  ```
  shopRule.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_DEFAULT);
  ```

### 2. 算法选择原因

1. **预热令牌桶算法**选择理由：
   - 系统识别到秒杀场景流量模式具有突增特性
   - 预热机制允许系统在流量突增时逐步提升接受能力
   - 适合从低负载突然切换到高负载的场景，如秒杀开始瞬间
   - 可以防止系统因为突发流量导致的完全崩溃

2. **漏桶算法**选择理由：
   - 提供了稳定的处理速率，特别适合后端服务能力有明确上限的场景
   - 实践表明系统在稳定 1600 并发时性能最佳
   - 能有效防止突发流量冲击数据库等核心资源

## 多级保护策略协同工作机制

系统实现了限流、熔断、降级三层保护机制，以分层次抵御不同类型的系统压力：

### 1. 层次化防护结构

```
第一层：限流保护（流量入口）
↓
第二层：熔断保护（服务内部）
↓  
第三层：降级保护（业务功能）
```

### 2. 协同工作机制

1. **限流层先行拦截**
   - 根据配置的QPS阈值和并发线程数阈值过滤请求
   - 秒杀接口采用QPS限流(阈值=1600)
   - 下单接口采用并发线程数限流(阈值=1600×0.8=1280)
   - 系统层面设置CPU使用率上限(75%)和最大线程数限制

2. **熔断层感知异常**
   - 通过异常比率和响应时间指标触发熔断
   - 秒杀接口根据平均RT(>100ms)触发熔断
   - 下单接口根据异常比例(>20%)触发熔断
   - 熔断后暂时拒绝新请求，避免资源进一步恶化

3. **降级层优雅退让**
   - 根据熔断信息和系统负载选择合适的降级策略
   - 通过`ProductTypeHandlerFactory`实现不同类商品处理策略的差异化降级
   - 系统监控组件`SystemMonitor`实时监测CPU和内存使用情况

### 3. 实际协同处理流程示例

在秒杀高峰期的协同工作流程：

1. **正常流量阶段**
   - 限流层：按预热机制逐步提升流量接收能力
   - 熔断层：监控RT和异常率，尚未触发阈值
   - 降级层：全功能运行

2. **流量突增阶段**
   - 限流层：当QPS超过1600时，拒绝过量请求(返回429状态码)
   - 系统保护规则：当CPU使用率接近75%时，自动降低接受流量
   - 热点数据预热：自动为热门商品建立缓存，减轻数据库压力

3. **异常高发阶段**
   - 熔断层：检测到下单接口异常率超过20%，触发熔断
   - 降级层：自动选择降级策略，如返回缓存数据、简化业务规则
   - 恢复机制：熔断时窗期(30秒)后，系统尝试恢复服务

4. **系统过载阶段**
   - 多级联动：`SystemMonitor`检测系统负载趋势持续上升
   - 主动降级：触发布隆过滤器监控任务，减少重建频次
   - 告警机制：当发现误判率超过10%时，系统通过XXL-Job日志报警

这种多层次防护机制确保了系统在高负载情况下仍能保持核心功能可用，并在负载降低后能够自动恢复全部服务能力。

初步压力测试，线程数2200左右时性能出现劣化

### 1. 库存扣减优化

目前项目中有`seckill.lua`脚本实现了秒杀，可以进一步优化为：

- 库存分层架构：Redis预留90%，数据库10%
- 增加库存校准机制：每次操作记录日志，定时任务校对Redis与DB库存
- 在`TicketStockService`中优化热点商品的库存处理逻辑

### 2. 异步处理改造

- 将[VoucherOrderController](vscode-file://vscode-app/d:/%E5%B7%A5%E5%85%B7/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)中的秒杀接口改为完全异步模式
- 建立临时表存储支付回调，并由定时任务批量处理
- 优惠券核销等非核心流程异步化处理

### 3. 热点数据处理升级

[TicketHeatManager](vscode-file://vscode-app/d:/%E5%B7%A5%E5%85%B7/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)已经实现了热点识别，可以进一步：

- 引入本地缓存作为第一级缓存（目前系统已有Caffeine实现）
- 基于[TicketHeatEvaluationTask](vscode-file://vscode-app/d:/%E5%B7%A5%E5%85%B7/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)动态调整缓存策略
- 大key拆分（如大量用户抢同一商品时）

### 4. 限流与熔断增强

基于现有的`OrderStateAutoTransferTask`任务机制：

- 增加网关级限流
- 在核心接口添加Sentinel熔断降级
- 接入动态配置，支持热更新限流规则
- 实现请求分级处理，保障重要流程优先执行

### 5. 数据库优化

- 考虑调整事务隔离级别为RC
- 优化SQL语句，减少锁争用
- 引入显式锁处理幻读问题
- 移除非必要事务，缩短事务持有时间



## 1. 库存分层设计（Redis预扣90%，DB保留10%）

这项优化主要针对的问题：

- **Redis性能优势未充分利用**：Redis内存操作比MySQL快数千倍，适合处理高并发库存扣减
- **单点风险**：原系统若Redis崩溃，整个秒杀系统无法正常工作
- **超卖风险**：高并发下可能出现库存一致性问题

**为什么要这样做：**

- **高并发承载**：通过Redis原子操作（Lua脚本）可支撑数万QPS的库存扣减
- **灾备方案**：Redis不可用时，10%的DB库存作为应急保障
- **一致性保障**：通过日志记录和库存校准机制解决了Redis与DB库存同步问题
- **解决热点问题**：避免直接操作DB热点行，减轻InnoDB锁争用

## 2. 支付回调异步化（临时表削峰）

这项优化主要针对的问题：

- **支付回调流量不可控**：支付成功回调可能在短时间内集中爆发
- **串行链路处理慢**：实时扣减库存+状态变更+履约逻辑串行执行延长响应时间
- **用户体验差**：前端需长时间等待轮询结果

**为什么要这样做：**

- **流量削峰**：支付回调只需写入临时表即可返回，不再直接操作热点库存表
- **提升吞吐量**：定时批量处理比实时单条处理效率高10倍以上
- **降低资源消耗**：减少数据库连接和事务开销
- **链路并行化**：将原来串行的多个步骤改为并行处理，显著缩短响应时间

## 3. 数据库优化（RR改为RC）

这项优化主要针对的问题：

- **并发度不足**：RR隔离级别下Gap Lock和Next-Key Lock导致并行受限
- **锁竞争严重**：悲观锁机制导致锁等待时间长，事务阻塞明显
- **死锁频发**：大范围锁导致死锁概率增大

**为什么要这样做：**

- **提高并发度**：RC只锁定实际修改的行，不加间隙锁，并发性能提升30%-50%
- **减少锁范围**：降低了锁冲突概率和死锁风险
- **支持半一致读**：对不满足条件的记录可提前释放锁，提升UPDATE效率
- **缺点弥补**：通过显式分布式锁或业务层原子操作弥补幻读问题

## 4. 多级缓存与热点处理

这项优化主要针对的问题：

- **缓存击穿**：热点数据过期瞬间导致DB压力激增
- **缓存穿透**：恶意请求不存在的数据导致DB负载高
- **热点商品负载**：热门商品被频繁访问，Redis单点压力大
- **连接资源争用**：Redis连接池不足导致服务延迟

**为什么要这样做：**

- **分层缓存架构**：本地缓存(Caffeine) → Redis缓存 → DB，层层防护
- **布隆过滤器**：有效拦截对不存在数据的请求，防止穿透到DB
- **热点识别与预热**：通过访问统计动态识别热点商品，主动预热
- **大key拆分**：将热点商品数据水平分片，分散访问压力
- **逻辑过期**：热点数据使用逻辑过期代替物理过期，避免击穿问题

## 5. 限流与熔断策略

这项优化主要针对的问题：

- **流量洪峰**：秒杀瞬间流量激增导致系统崩溃
- **资源耗尽**：线程池、连接池等资源被迅速耗尽
- **雪崩效应**：单点服务故障导致级联失败

**为什么要这样做：**

- **多级防护**：网关层、应用层、接口层三级限流确保系统稳定
- **动态调整**：根据实时监控自动调整限流阈值，应对流量变化
- **熔断降级**：检测到异常后迅速熔断，避免连锁故障
- **分级策略**：针对不同业务重要性实施差异化限流和降级策略
- **预热保护**：Sentinel限流器的预热机制避免冷启动问题
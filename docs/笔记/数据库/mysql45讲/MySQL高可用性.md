

1. **核心主题**
    
    - MySQL的高可用性不仅依赖于主备复制的最终一致性，更关键在于如何有效管理和执行主备切换，尤其是在存在主备延迟的情况下。
        
    - 文章探讨了主备延迟的成因、影响以及在不同切换策略（可靠性优先与可用性优先）下的权衡。
        
2. **知识点**
    
    1. **主备延迟 (T3-T1)**：指同一个事务在备库执行完成的时间 (T3) 与主库执行完成的时间 (T1) 之间的差值。
        
        - seconds_behind_master：备库上显示的主备延迟秒数，计算方式为备库当前执行事务的binlog时间戳与备库系统时间的差值（已校准主备系统时间差）。
            
        - 网络正常时，延迟主要来源于备库接收完binlog到执行完事务之间的时间差 (T3-T2)。
            
    2. **主备延迟的来源**：
        
        - **备库性能较差**：备库机器配置低于主库（现已较少见，推荐对称部署）。
            
        - **备库压力过大**：备库承担过多读请求、分析查询或备份任务，消耗大量CPU/IO资源。
            
            - 解决方案：一主多从分担读压力；使用外部系统（如Hadoop）进行统计分析。
                
        - **大事务**：主库上执行耗时长的事务（如无索引的大量DELETE、大表DDL），导致binlog延迟传递和应用。
            
            - 解决方案：分批删除数据；DDL使用gh-ost等工具。
                
        - **备库并行复制能力**：也是影响延迟的因素（文中提及将在后续文章详述）。
            
    3. **主备切换策略**：
        
        - **可靠性优先策略**：
            
            1. 判断备库seconds_behind_master是否小于阈值。
                
            2. 主库A设为只读。
                
            3. 等待备库B的seconds_behind_master变为0。
                
            4. 备库B设为可读写。
                
            5. 业务请求切换到备库B。
                
            
            - 特点：保证数据最终一致性，但步骤3可能导致较长不可写时间。
                
        - **可用性优先策略**：
            
            1. 直接将业务请求切到备库B。
                
            2. 备库B设为可读写。
                
            
            - 特点：系统几乎无不可用时间，但可能导致数据不一致。
                
            - binlog_format=mixed/statement：数据不一致可能悄悄发生，难以察觉。
                
            - binlog_format=row：数据不一致更容易通过duplicate key error等错误被发现，主备同步可能因此停止。
                
    4. **异常切换（主库掉电）**：
        
        - 若采用可靠性优先，必须等待备库应用完所有中转日志（seconds_behind_master=0）才能提供写服务，期间系统完全不可用。
            
        - 直接切换到备库并保持只读也不可取，因为客户端可能查询到“暂时丢失”的数据。
            
    5. **双M结构循环复制场景**：
        
        - 主库更新后修改server_id，导致日志传回时被自己执行。
            
        - 三节点（A-B，A-A'双M）结构，B的更新传给A，A会传给A'，A'又可能传回A。
            
        - 解决方法：临时使用CHANGE MASTER TO IGNORE_SERVER_IDS=(server_id_of_source)。
            
3. **主要结论/启示**
    
    1. **数据可靠性优先**：对于数据库服务，通常应优先选择“可靠性优先”的切换策略，保证数据准确性是底线。
        
    2. **主备延迟是关键**：MySQL高可用系统的可用性高度依赖于主备延迟。延迟越小，主库故障时服务恢复时间越短，可用性越高。
        
    3. **binlog_format=row更安全**：在可能发生数据不一致的场景下，row格式更容易暴露问题，便于及时发现和处理。
        
    4. **减少延迟的措施**：应积极采取措施（如对称部署、读写分离、避免大事务、优化备库并行复制）来减少主备延迟。
        
    5. **权衡与设计**：在特定场景下（如非核心日志库且业务强依赖写入），可能需要考虑可用性优先，但更优的方案是改进业务设计，使其不强依赖此类组件的实时写入。
        
    6. **监控的重要性**：对seconds_behind_master等指标的持续监控，是及时发现和处理主备延迟问题的前提。
        

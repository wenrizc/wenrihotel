对于非流式AI调用，会返回Mono类型结果，一次传递所有文本。在收到AI服务商返回的结果后，插件会将文本传递到处理链中，先计算Token消耗量，随后在redis中获取对应的锁并扣减代理key余额。如果余额小于零，网关会在返回结果的同时返回警告信息。

对于流式AI调用，会返回Flux类型结果，结果会拆分成多个小块，通过长连接陆续推送给客户端。处理链在未检查到流终止时会不断循环。对于传入进的多个小块文本每次都会在redis中取锁扣减余额。如果某次扣减后余额小于0，说明限额耗尽，此时立即向上游AI服务发出终止信号，尝试关闭流式连接，并返回警告信息。

